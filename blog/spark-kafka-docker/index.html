<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Tran Lam" href="/blogs/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/blogs/blog/rss.xml" title="Tran Lam RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blogs/blog/atom.xml" title="Tran Lam Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">Tạo luồng streaming dữ liệu với Spark Streaming, Kafka, Docker</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lam1051999.github.io//blogs/blog/spark-kafka-docker"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Tạo luồng streaming dữ liệu với Spark Streaming, Kafka, Docker | Tran Lam"><meta data-rh="true" name="description" content="Architecture"><meta data-rh="true" property="og:description" content="Architecture"><meta data-rh="true" property="og:image" content="https://lam1051999.github.io//blogs/assets/images/architecture-77309774b4b463947f6f1f3ef0a8f0dc.PNG"><meta data-rh="true" name="twitter:image" content="https://lam1051999.github.io//blogs/assets/images/architecture-77309774b4b463947f6f1f3ef0a8f0dc.PNG"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-09-11T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/lam1051999"><meta data-rh="true" property="article:tag" content="Bigdata,Spark,Apache,Kafka,Docker"><link data-rh="true" rel="icon" href="/blogs/img/de.svg"><link data-rh="true" rel="canonical" href="https://lam1051999.github.io//blogs/blog/spark-kafka-docker"><link data-rh="true" rel="alternate" href="https://lam1051999.github.io//blogs/blog/spark-kafka-docker" hreflang="en"><link data-rh="true" rel="alternate" href="https://lam1051999.github.io//blogs/blog/spark-kafka-docker" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KPAEHOL9XK-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/blogs/assets/css/styles.7b917ad4.css">
<link rel="preload" href="/blogs/assets/js/runtime~main.a12d6af5.js" as="script">
<link rel="preload" href="/blogs/assets/js/main.784bdc81.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/blogs/"><div class="navbar__logo"><img src="/blogs/img/de.svg" alt="TL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/blogs/img/de.svg" alt="TL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Tran Lam</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blogs/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blogs/blog">Blog</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/spark-catalyst-optimizer-and-spark-extension">Spark catalyst optimizer và Spark extension</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-indexing">MySQL series - Indexing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-mvcc">MySQL series - Multiversion concurrency control</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-transaction">MySQL series - Transaction trong MySQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-architecture">MySQL series - Tổng quan kiến trúc MySQL</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blogs/blog/spark-kafka-docker">Tạo luồng streaming dữ liệu với Spark Streaming, Kafka, Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/spark-cluster-docker">Tạo 1 Standalone Spark Cluster với Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/ai-interview-questions">Một số câu hỏi phỏng vấn AI/ML</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/receptive-field">Receptive field trong thị giác máy tính</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/linear-algebra-part-1">Đại số tuyến tính cơ bản - Phần 1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/probability">Xác suất thống kê cơ bản</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/avl-tree">Cây AVL, thuật toán sắp xếp AVL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/binarysearch-tree">Cây tìm kiếm nhị phân</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/sorting-algorithms">Các thuật toán sắp xếp cơ bản</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/peak-finding">Thuật toán tìm đỉnh Peak Finding</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">Tạo luồng streaming dữ liệu với Spark Streaming, Kafka, Docker</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-09-11T00:00:00.000Z" itemprop="datePublished">September 11, 2022</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lam1051999.png" alt="Trần Lâm"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Trần Lâm</span></a></div><small class="avatar__subtitle" itemprop="description">Data Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://lam1051999.github.io//blogs/assets/images/architecture-77309774b4b463947f6f1f3ef0a8f0dc.PNG"><div id="post-content" class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="Architecture" src="/blogs/assets/images/architecture-77309774b4b463947f6f1f3ef0a8f0dc.PNG" width="1920" height="1080" class="img_ev3q"></p><p>Chào các bạn, mình đã trở lại sau một thời gian khá lâu chưa viết gì. Hôm nay, mình muốn chia sẻ về cách tạo 1 luồng Spark Streaming tiêu thụ dữ liệu từ Kafka, tất cả mọi thứ được dựng trên Docker.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-tổng-quan-mô-hình">1. Tổng quan mô hình<a class="hash-link" href="#1-tổng-quan-mô-hình" title="Direct link to heading">​</a></h3><p>Mô hình được containerize bởi Docker. Bao gồm các thành phần sau</p><ul><li>Producer: là một Kafka Producer sản xuất dữ liệu fake về thông tin một cá thể bằng Java Faker và bắn các message lên Kafka.</li><li>Kafka cluster: bao gồm các broker để lưu trữ dữ liệu và Zookeeper để quản lý các broker đó.</li><li>Spark cluster: là một cụm Spark gồm 3 nodes: 1 driver và 2 worker để tiêu thụ dữ liệu từ Kafka.</li><li>Schema Registry: cung cấp restful interface để lưu trữ và lấy các schema, giúp cho Kafka producer và consumer hoạt động với nhau theo quy chuẩn. Khi mà 2 đầu sản xuất và tiêu thụ message từ 2 đầu Kafka là độc lập, bên đầu tiêu thụ không cần biết bên sản xuất bắn message với format thế nào, thì Schema Registry như là trung gian để 2 bên đăng kí format message với nhau, tránh lỗi hệ thống.</li><li>Postgres: là database để cung cấp các cấu hình cho app Spark Streaming và ở bài viết này cũng là nơi để đẩy dữ liệu streaming xuống. </li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-dựng-các-container-cần-thiết-trên-docker">2. Dựng các container cần thiết trên Docker<a class="hash-link" href="#2-dựng-các-container-cần-thiết-trên-docker" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21-tạo-spark-cluster">2.1. Tạo Spark cluster<a class="hash-link" href="#21-tạo-spark-cluster" title="Direct link to heading">​</a></h4><p>Như trong <strong><a href="/blogs/blog/spark-cluster-docker">bài viết trước</a></strong> mình có viết về cách dựng cụm Spark trên Docker, ở bài này mình tận dụng luôn cụm đó. Tuy nhiên, có một chút thay đổi, lược bỏ đi một số thứ để phù hợp với bài viết này. Các bạn có thể tìm được script build image <strong><a href="https://github.com/lam1051999/spark_kafka_docker/tree/main/spark_cluster" target="_blank" rel="noopener noreferrer">tại đây</a></strong>. Thế là ta đã có các image cần thiết cho Spark cluster. Sau đây là phần cấu hình các container trong docker-compose.yml</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">spark-master</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">master</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">master</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> 8080</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> 7077</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">7077</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> 4040</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">4040</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> /Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/target</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/execution_files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">spark-worker-1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">worker</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">worker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> SPARK_WORKER_CORES=1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> SPARK_WORKER_MEMORY=1024m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> 18081</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">8081</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> /Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/target</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/execution_files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">master</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">spark-worker-2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">worker</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">worker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> SPARK_WORKER_CORES=1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> SPARK_WORKER_MEMORY=1024m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> 28081</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">8081</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> /Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/target</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/execution_files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">master</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22-thêm-các-container-zookeeper-kafka-postgres-schema-registry">2.2. Thêm các container Zookeeper, Kafka, Postgres, Schema Registry<a class="hash-link" href="#22-thêm-các-container-zookeeper-kafka-postgres-schema-registry" title="Direct link to heading">​</a></h4><p>Tiếp theo sẽ là lên các container Zookeeper, Kafka, Postgres và Schema Registry</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">zookeeper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> confluentinc/cp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">zookeeper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">3.3.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> zookeeper</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;2181:2181&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ZOOKEEPER_CLIENT_PORT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ZOOKEEPER_TICK_TIME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">kafka</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> confluentinc/cp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">kafka</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">3.3.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> zookeeper</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;29092:29092&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">KAFKA_BROKER_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">KAFKA_ZOOKEEPER_CONNECT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">2181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">KAFKA_ADVERTISED_LISTENERS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> PLAINTEXT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//kafka</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">9092</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">PLAINTEXT_HOST</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">29092</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> PLAINTEXT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">PLAINTEXT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">PLAINTEXT_HOST</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">PLAINTEXT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> PLAINTEXT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">db</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> db</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./data/db</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/var/lib/postgresql/data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;5432:5432&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> POSTGRES_NAME=postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> POSTGRES_USER=postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> POSTGRES_PASSWORD=postgres</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">schema-registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> confluentinc/cp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">schema</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">3.3.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> schema</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> zookeeper</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;8081:8081&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> zookeeper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">2181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">SCHEMA_REGISTRY_HOST_NAME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> schema</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">registry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Tổng hợp lại, ta có một file docker-compose.yml hoàn chỉnh như <strong><a href="https://github.com/lam1051999/spark_kafka_docker/blob/main/spark_ex/docker-compose.yml" target="_blank" rel="noopener noreferrer">ở đây</a></strong>.
Sau đó, ta thực hiện khởi động các container bằng</p><div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker-compose up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Lưu ý, việc này khởi động tất cả các container cùng một lúc, một số trường hợp Kafka và Schema Registry sẽ bị lỗi vì nó phụ thuộc vào Zookeeper. Hãy chờ container Zookeeper lên xong rồi restart lại container Kafka và Schema Registry.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-tạo-một-kafka-producer-bắn-dữ-liệu-giả-bằng-java-faker">3. Tạo một Kafka Producer bắn dữ liệu giả bằng Java Faker<a class="hash-link" href="#3-tạo-một-kafka-producer-bắn-dữ-liệu-giả-bằng-java-faker" title="Direct link to heading">​</a></h3><p>Tiếp đến, ta tạo một Kafka Producer để bắn dữ liệu giả bằng Java. Trước tiên, ta cần tạo 1 schema trên Schema Registry. Vì Schema Registry cung cấp một restful interface nên ta có thể dễ dàng tương tác với nó bằng các lời gọi GET, POST,... Schema ta sử dụng trong bài viết này sẽ có dạng như sau</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;com.cloudurable.phonebook&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;record&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Employee&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;doc&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Represents an Employee at a company&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;id&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The person id&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;firstName&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The persons given name&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;nickName&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;null&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token null keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;lastName&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;age&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;int&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;default&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">-1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;emails&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;The person email&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;phoneNumber&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;record&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">   </span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;PhoneNumber&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;areaCode&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;countryCode&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;prefix&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;number&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;status&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Trước hết, để POST schema này lên Schema Registry, ta phải chuyển schema này về dạng escaped json, truy cập <strong><a href="https://www.freeformatter.com/json-escape.html" target="_blank" rel="noopener noreferrer">trang web này</a></strong> để chuyển.
Sau đó, dùng POST method để push schema lên như sau</p><div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl -X POST -H &quot;Content-Type: application/vnd.schemaregistry.v1+json&quot; \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --data &#x27;{&quot;schema&quot;: &quot;{\&quot;namespace\&quot;: \&quot;com.cloudurable.phonebook\&quot;,\&quot;type\&quot;: \&quot;record\&quot;,\&quot;name\&quot;: \&quot;Employee\&quot;,\&quot;doc\&quot; : \&quot;Represents an Employee at a company\&quot;,\&quot;fields\&quot;: [{\&quot;name\&quot;: \&quot;id\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;doc\&quot;: \&quot;The person id\&quot;},{\&quot;name\&quot;: \&quot;firstName\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;doc\&quot;: \&quot;The persons given name\&quot;},{\&quot;name\&quot;: \&quot;nickName\&quot;, \&quot;type\&quot;: [\&quot;null\&quot;, \&quot;string\&quot;], \&quot;default\&quot; : null},{\&quot;name\&quot;: \&quot;lastName\&quot;, \&quot;type\&quot;: \&quot;string\&quot;},{\&quot;name\&quot;: \&quot;age\&quot;,  \&quot;type\&quot;: \&quot;int\&quot;, \&quot;default\&quot;: -1},{\&quot;name\&quot;: \&quot;emails\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;doc\&quot;: \&quot;The person email\&quot;},{\&quot;name\&quot;: \&quot;phoneNumber\&quot;,  \&quot;type\&quot;:{ \&quot;type\&quot;: \&quot;record\&quot;,   \&quot;name\&quot;: \&quot;PhoneNumber\&quot;,\&quot;fields\&quot;: [{\&quot;name\&quot;: \&quot;areaCode\&quot;, \&quot;type\&quot;: \&quot;string\&quot;},{\&quot;name\&quot;: \&quot;countryCode\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;default\&quot; : \&quot;\&quot;},{\&quot;name\&quot;: \&quot;prefix\&quot;, \&quot;type\&quot;: \&quot;string\&quot;},{\&quot;name\&quot;: \&quot;number\&quot;, \&quot;type\&quot;: \&quot;string\&quot;}]}},{\&quot;name\&quot;: \&quot;status\&quot;, \&quot;type\&quot;: \&quot;string\&quot;}]}&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  http://localhost:8081/subjects/personinformation-value/versions</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Sau đó, GET về để check xem schema đã lên hay chưa</p><div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl -X GET http://localhost:8081/subjects/personinformation-value/versions/ // xem các version</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">curl -X GET http://localhost:8081/subjects/personinformation-value/versions/1 // xem schema version 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Khi này, Kafka đã lên, schema đã có trên Schema Registry, việc còn lại là đẩy message lên topic đó. Viết một class như sau (xem đầy đủ code <strong><a href="https://github.com/lam1051999/spark_kafka_docker/tree/main/KafkaClient" target="_blank" rel="noopener noreferrer">tại đây</a></strong>), và chạy thì dữ liệu đã lên Kafka với chema ở trên rồi.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">package kafkaclient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import com.github.javafaker.Faker;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import io.confluent.kafka.serializers.KafkaAvroSerializerConfig;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.avro.Schema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.avro.generic.GenericData;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.avro.generic.GenericRecord;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.kafka.clients.producer.KafkaProducer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.kafka.clients.producer.Producer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import io.confluent.kafka.serializers.KafkaAvroSerializer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.kafka.clients.producer.ProducerConfig;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.kafka.clients.producer.ProducerRecord;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.kafka.common.serialization.StringSerializer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.File;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.Properties;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public class KafkaProducerExample {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private final static String TOPIC = &quot;personinformation&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private final static String BOOTSTRAP_SERVERS = &quot;localhost:29092&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private final static String SCHEMA_REGISTRY_URL = &quot;http://localhost:8081&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private final static String LOCAL_SCHEMA_PATH = &quot;src/main/resources/person.avsc&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private final static Schema schema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private final static int nPersons = 1000;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            schema = new Schema.Parser().parse(new File(LOCAL_SCHEMA_PATH));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private static Producer&lt;String, GenericRecord&gt; createProducer(){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Properties props = new Properties();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, KafkaAvroSerializer.class.getName());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        props.put(KafkaAvroSerializerConfig.SCHEMA_REGISTRY_URL_CONFIG, SCHEMA_REGISTRY_URL);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new KafkaProducer&lt;&gt;(props);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    static void runProducer() {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        final Producer&lt;String, GenericRecord&gt; producer = createProducer();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Faker faker = new Faker();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (int i = 0; i &lt; nPersons; i ++){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String id = faker.idNumber().valid();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String firstName = faker.name().firstName();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String nickName = faker.name().username();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String lastName = faker.name().lastName();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            int age = faker.number().numberBetween(18, 90);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//            ArrayList&lt;String&gt; emails = new ArrayList&lt;String&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//            int nEmails = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//            for(int k = 0; k &lt; nEmails; k++){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//                emails.add(faker.internet().safeEmailAddress());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String emails = faker.internet().safeEmailAddress();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String areaCode = String.valueOf(faker.number().numberBetween(200, 500));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String countryCode = String.valueOf(faker.number().numberBetween(80, 85));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String prefix = String.valueOf(faker.number().numberBetween(400, 600));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            String number = String.valueOf(faker.number().numberBetween(1234, 6789));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            GenericRecord phoneNumber = new GenericData.Record(schema.getField(&quot;phoneNumber&quot;).schema());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            phoneNumber.put(&quot;areaCode&quot;, areaCode);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            phoneNumber.put(&quot;countryCode&quot;, countryCode);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            phoneNumber.put(&quot;prefix&quot;, prefix);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            phoneNumber.put(&quot;number&quot;, number);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            StatusEnum status = StatusEnum.getRandomStatus();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            GenericRecord personInfo = new GenericData.Record(schema);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;id&quot;, id);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;firstName&quot;, firstName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;nickName&quot;, nickName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;lastName&quot;, lastName);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;age&quot;, age);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;emails&quot;, emails);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;phoneNumber&quot;, phoneNumber);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            personInfo.put(&quot;status&quot;, status.toString());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ProducerRecord&lt;String, GenericRecord&gt; data = new ProducerRecord&lt;String, GenericRecord&gt;(TOPIC, String.format(&quot;%s %s %s&quot;, firstName, lastName, nickName), personInfo);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            producer.send(data);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            System.out.println(&quot;Send successfully!!!&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                Thread.sleep(2000);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }catch (Exception e){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            runProducer();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }catch (Exception e){</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ở trên, mỗi 2 giây ta sẽ đẩy 1 message lên Kafka, đẩy tổng cộng 1000 message.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-submit-job-spark">4. Submit job Spark<a class="hash-link" href="#4-submit-job-spark" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-cấu-hình-postgres">4.1. Cấu hình Postgres<a class="hash-link" href="#41-cấu-hình-postgres" title="Direct link to heading">​</a></h4><p>Trước khi có thể chạy job, ta cần cấu hình Postgres với các bảng sau</p><ul><li>Bảng cấu hình app Spark chạy</li></ul><div class="language-postgres codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-postgres codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE spark_launcher_config (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id serial primary  key,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;desc&quot; varchar(1000) NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    app_name varchar(255) NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    properties text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    created timestamp without time zone DEFAULT (now() at time zone &#x27;Asia/Ho_Chi_Minh&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    modified timestamp without time zone DEFAULT (now() at time zone &#x27;Asia/Ho_Chi_Minh&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">INSERT INTO public.spark_launcher_config</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    (id, &quot;desc&quot;, app_name, properties, created, modified)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    VALUES(2, &#x27;kafka_ingest&#x27;, &#x27;ingest_avro_from_kafka&#x27;, &#x27;{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;appname&quot;: &quot;ingest_avro_from_kafka&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;master&quot;: &quot;spark://spark-master:7077&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;duration&quot;: &quot;10&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;groupId&quot;: &quot;ingest_avro_from_kafka&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;zookeeper.hosts&quot;: &quot;zookeeper:2181&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;checkpoint&quot;: &quot;./spark_checkpoint/ingest_avro_from_kafka&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;zookeeper.timeout&quot;: &quot;40000&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;spark.sql.shuffle.partitions&quot;: &quot;10&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;spark.sql.sources.partitionOverwriteMode&quot;: &quot;dynamic&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;spark.sql.hive.verifyPartitionPath&quot;: &quot;true&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;spark.streaming.kafka.maxRatePerPartition&quot;: 10000,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.bootstrap.servers&quot;: &quot;kafka:9092&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.group.id&quot;: &quot;ingest_avro_from_kafka&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.auto.offset.reset&quot;: &quot;earliest&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.max.poll.interval.ms&quot;: 5000000,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.max.poll.records&quot;: 10000,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.schema.registry.url&quot;: &quot;http://schema-registry:8081&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.auto.commit&quot;: &quot;false&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.session.timeout.ms&quot;: &quot;50000&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.heartbeat.interval.ms&quot;: &quot;25000&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;_kafka_.request.timeout.ms&quot;: &quot;50000&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }&#x27;, &#x27;2022-04-12 09:35:27.511&#x27;, &#x27;2022-04-12 09:35:27.511&#x27;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Bảng cấu hình tiêu thụ topic</li></ul><div class="language-postgres codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-postgres codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE spark_ingest_config (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id serial primary key,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    app_name varchar(255) not null unique,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type varchar(255)  NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;order&quot; int NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    topic varchar(255) not null unique,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    status int not null DEFAULT 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fields text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    temp_view_first varchar(255)  NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql_parser text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    prd_id varchar(255)  NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    keys varchar(255)  NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    path_hdfs varchar(255) NOT NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    table_dest varchar(255) NOT NULL,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    impala_driver varchar(255) null DEFAULT &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    impala_url varchar(255) null DEFAULT &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafka_msg_type kkmt DEFAULT &#x27;avro_flat&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    json_schema text,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repartition_des int not null DEFAULT 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg_type mst DEFAULT &#x27;NOT_DEFINE&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    created timestamp without time zone DEFAULT (now() at time zone &#x27;Asia/Ho_Chi_Minh&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    modified timestamp without time zone DEFAULT (now() at time zone &#x27;Asia/Ho_Chi_Minh&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">INSERT INTO public.spark_ingest_config</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">(id, app_name, &quot;type&quot;, &quot;order&quot;, topic, status, fields, temp_view_first, sql_parser, prd_id, keys, path_hdfs, table_dest, impala_driver, impala_url, kafka_msg_type, json_schema, repartition_des, msg_type, created, modified)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">VALUES(1, &#x27;ingest_avro_from_kafka&#x27;, &#x27;insert&#x27;, 0, &#x27;personinformation&#x27;, 1, &#x27;firstName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">nickName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">lastName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">age,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">emails,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">phoneNumber,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">status&#x27;, &#x27;ingest_avro_from_kafka_personinformation&#x27;, &#x27;select </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cast(firstName as STRING) as firstName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cast(nickName as STRING) as nickName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cast(lastName as STRING) as lastName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cast(age as INT) as age,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cast(emails as STRING) as emails,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cast(concat(phoneNumber.countryCode, &quot;-&quot;, phoneNumber.areaCode, &quot;-&quot;, phoneNumber.prefix, &quot;-&quot;, phoneNumber.number) as STRING) as phoneNumber,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cast(status as STRING) as status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from ingest_avro_from_kafka_personinformation&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;personinformation&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;avro_flat&#x27;::public.&quot;kkmt&quot;, &#x27;&#x27;, 1, &#x27;NOT_DEFINE&#x27;::public.&quot;mst&quot;, &#x27;2022-04-06 19:59:41.745&#x27;, &#x27;2022-04-06 19:59:41.745&#x27;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Bảng lưu dữ liệu streaming</li></ul><div class="language-postgres codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-postgres codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">create table personinformation (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    firstName varchar(250) not null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    nickName varchar(250) not null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lastName varchar(250) not null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    age integer not null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    emails varchar(250) not null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    phoneNumber varchar(250) not null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    status varchar(10) not null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-cấu-hình-spark">4.2. Cấu hình Spark<a class="hash-link" href="#42-cấu-hình-spark" title="Direct link to heading">​</a></h4><p>Code Spark Streaming đầy đủ bạn có thể tìm thấy <strong><a href="https://github.com/lam1051999/spark_kafka_docker/tree/main/spark_ex" target="_blank" rel="noopener noreferrer">tại đây</a></strong>. Các bạn compile project bằng việc chạy</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sh run.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Khi mọi container đã chạy ổn định, Kafka đã có dữ liệu, ta truy cập vào shell của container Spark master</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker exec -it spark-master bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Sau khi đã vào shell, bạn tiếp tục chạy lệnh dưới đây để submit job Spark</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$SPARK_HOME/bin/spark-submit --jars $(echo /execution_files/dependency/*.jar | tr &#x27; &#x27; &#x27;,&#x27;) --class com.tranlam.App /execution_files/spark_ex-1.0-SNAPSHOT.jar --app-name ingest_avro_from_kafka --jdbc-url &quot;jdbc:postgresql://db:5432/postgres?user=postgres&amp;password=postgres&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Như vậy là đã có 1 job Spark tiêu thụ dữ liệu Kafka rồi. Sau đó bạn truy cập <strong><a href="http://localhost:4040/streaming" target="_blank" rel="noopener noreferrer">http://localhost:4040/streaming</a></strong> để xem các batch đang chạy</p><p><img loading="lazy" alt="Architecture" src="/blogs/assets/images/spark-ui-1ecafa9bf152aeeb9696a63ce919b27e.PNG" width="2878" height="1708" class="img_ev3q"></p><p>Vào Postgres query bảng <code>personinformation</code> ta thấy có dữ liệu như mong muốn</p><p><img loading="lazy" alt="Postgres" src="/blogs/assets/images/postgres-5773b8ab0a455f7ac006cae76556a096.PNG" width="936" height="378" class="img_ev3q"></p><p>Trên đây là tất cả nội dung để dựng một luồng streaming cơ bản từ Kafka. Còn một điều lưu ý nữa là thay vì bạn commit offset của các lần tiêu thụ lên 1 topic của Kafka như trong code Spark, bạn có thể commit nó một cách thủ công vào một đường dẫn ở Zookeeper để chủ động hơn trong việc kiểm soát.</p><p>Code của cả bài viết bạn đọc có thể tìm thấy ở đây: <strong><a href="https://github.com/lam1051999/spark_kafka_docker" target="_blank" rel="noopener noreferrer">https://github.com/lam1051999/spark_kafka_docker</a></strong></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_u0Nl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/bigdata">Bigdata</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/spark">Spark</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/apache">Apache</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/kafka">Kafka</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/docker">Docker</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lam1051999/blogs/edit/main/blog/2022-09-11-spark-kafka-docker/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div class="margin-vert--xl"></div><div class="margin-vert--lg" style="display:flex;align-items:center;justify-content:center"><a class="button button--link" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Flam1051999.github.io%2F%2Fblogs%2Fblog%2Fspark-kafka-docker&amp;text=I%20just%20read%20%22T%E1%BA%A1o%20lu%E1%BB%93ng%20streaming%20d%E1%BB%AF%20li%E1%BB%87u%20v%E1%BB%9Bi%20Spark%20Streaming%2C%20Kafka%2C%20Docker%22%20by%20%40kgajera24" target="_blank" rel="noreferrer noopener" style="display:inline-flex;align-items:center"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 248 204" height="20" width="20" style="margin-right:7px"><g><path fill="#1D9BF0" d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04 C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66 c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64 c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76 c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26 c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"></path></g></svg>Share on Twitter</a></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blogs/blog/mysql-series-mysql-architecture"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">MySQL series - Tổng quan kiến trúc MySQL</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blogs/blog/spark-cluster-docker"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Tạo 1 Standalone Spark Cluster với Docker</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-tổng-quan-mô-hình" class="table-of-contents__link toc-highlight">1. Tổng quan mô hình</a></li><li><a href="#2-dựng-các-container-cần-thiết-trên-docker" class="table-of-contents__link toc-highlight">2. Dựng các container cần thiết trên Docker</a><ul><li><a href="#21-tạo-spark-cluster" class="table-of-contents__link toc-highlight">2.1. Tạo Spark cluster</a></li><li><a href="#22-thêm-các-container-zookeeper-kafka-postgres-schema-registry" class="table-of-contents__link toc-highlight">2.2. Thêm các container Zookeeper, Kafka, Postgres, Schema Registry</a></li></ul></li><li><a href="#3-tạo-một-kafka-producer-bắn-dữ-liệu-giả-bằng-java-faker" class="table-of-contents__link toc-highlight">3. Tạo một Kafka Producer bắn dữ liệu giả bằng Java Faker</a></li><li><a href="#4-submit-job-spark" class="table-of-contents__link toc-highlight">4. Submit job Spark</a><ul><li><a href="#41-cấu-hình-postgres" class="table-of-contents__link toc-highlight">4.1. Cấu hình Postgres</a></li><li><a href="#42-cấu-hình-spark" class="table-of-contents__link toc-highlight">4.2. Cấu hình Spark</a></li></ul></li></ul></div></div></div></div></div><div class="footer-wrapper footer--dark"><div class="container margin-vert--lg"><div style="display:flex;justify-content:center"><div style="max-width:650px">I believe each of us was designed to do certain things, that we have certain duties. Most significantly, since nature intended us to be social creatures, we have duties to our fellow men.</div><div style="margin-left:30px;min-width:169px"><img src="/blogs/img/avatar.jpg" style="height:154px;width:139px"><p style="font-size:0.8em;margin-top:1em">Tran Lam<br>Data Engineer</p></div></div></div><div style="display:flex;justify-content:center"><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blogs/">About</a></li><li class="footer__item"><a class="footer__link-item" href="/blogs/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:lam1051999@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/lamtt1005" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="tel:+84962007024" target="_blank" rel="noopener noreferrer" class="footer__link-item">Phone<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Tran Lam. All content is the property of Tran Lam.</div></div></div></footer></div></div></div>
<script src="/blogs/assets/js/runtime~main.a12d6af5.js"></script>
<script src="/blogs/assets/js/main.784bdc81.js"></script>
</body>
</html>