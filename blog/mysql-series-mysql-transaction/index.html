<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Tran Lam" href="/blogs/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/blogs/blog/rss.xml" title="Tran Lam RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blogs/blog/atom.xml" title="Tran Lam Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">MySQL series - Transaction trong MySQL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lam1051999.github.io//blogs/blog/mysql-series-mysql-transaction"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="MySQL series - Transaction trong MySQL | Tran Lam"><meta data-rh="true" name="description" content="Poster"><meta data-rh="true" property="og:description" content="Poster"><meta data-rh="true" property="og:image" content="https://lam1051999.github.io//blogs/assets/images/transaction-d127eedc5523b254bf641791d40e6ce7.JPEG"><meta data-rh="true" name="twitter:image" content="https://lam1051999.github.io//blogs/assets/images/transaction-d127eedc5523b254bf641791d40e6ce7.JPEG"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-10-06T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/lam1051999"><meta data-rh="true" property="article:tag" content="Bigdata,MySQL,Database,Data Engineering,Transaction"><link data-rh="true" rel="icon" href="/blogs/img/de.svg"><link data-rh="true" rel="canonical" href="https://lam1051999.github.io//blogs/blog/mysql-series-mysql-transaction"><link data-rh="true" rel="alternate" href="https://lam1051999.github.io//blogs/blog/mysql-series-mysql-transaction" hreflang="en"><link data-rh="true" rel="alternate" href="https://lam1051999.github.io//blogs/blog/mysql-series-mysql-transaction" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KPAEHOL9XK-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/blogs/assets/css/styles.7b917ad4.css">
<link rel="preload" href="/blogs/assets/js/runtime~main.d957ccbe.js" as="script">
<link rel="preload" href="/blogs/assets/js/main.784bdc81.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/blogs/"><div class="navbar__logo"><img src="/blogs/img/de.svg" alt="TL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/blogs/img/de.svg" alt="TL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Tran Lam</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blogs/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blogs/blog">Blog</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/spark-catalyst-optimizer-and-spark-extension">Spark catalyst optimizer và Spark extension</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-indexing">MySQL series - Indexing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-mvcc">MySQL series - Multiversion concurrency control</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blogs/blog/mysql-series-mysql-transaction">MySQL series - Transaction trong MySQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-architecture">MySQL series - Tổng quan kiến trúc MySQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/spark-kafka-docker">Tạo luồng streaming dữ liệu với Spark Streaming, Kafka, Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/spark-cluster-docker">Tạo 1 Standalone Spark Cluster với Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/ai-interview-questions">Một số câu hỏi phỏng vấn AI/ML</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/receptive-field">Receptive field trong thị giác máy tính</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/linear-algebra-part-1">Đại số tuyến tính cơ bản - Phần 1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/probability">Xác suất thống kê cơ bản</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/avl-tree">Cây AVL, thuật toán sắp xếp AVL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/binarysearch-tree">Cây tìm kiếm nhị phân</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/sorting-algorithms">Các thuật toán sắp xếp cơ bản</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/peak-finding">Thuật toán tìm đỉnh Peak Finding</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">MySQL series - Transaction trong MySQL</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-10-06T00:00:00.000Z" itemprop="datePublished">October 6, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lam1051999.png" alt="Trần Lâm"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Trần Lâm</span></a></div><small class="avatar__subtitle" itemprop="description">Data Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://lam1051999.github.io//blogs/assets/images/transaction-d127eedc5523b254bf641791d40e6ce7.JPEG"><div id="post-content" class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="Poster" src="/blogs/assets/images/transaction-d127eedc5523b254bf641791d40e6ce7.JPEG" width="624" height="396" class="img_ev3q"></p><p>Bài viết tiếp theo trong series MySQL về transaction. Một hoạt động rất phổ biến trong MySQL nói riêng và các cơ sở dữ liệu quan hệ nói chung. Cùng đi vào bài viết nào.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-transaction-là-gì">1. Transaction là gì?<a class="hash-link" href="#1-transaction-là-gì" title="Direct link to heading">​</a></h3><p>Transaction là một tập các câu lệnh SQL kết hợp với nhau như là một đơn vị công việc. Nếu như database chạy thành công toàn bộ lệnh SQL trong nhóm đó, nó được coi là thành công. Nếu như một trong số lệnh SQL gặp lỗi, tất cả các lệnh SQL đã chạy hoặc chưa chạy sẽ không ảnh hưởng gì tới database. Ví dụ các một tập câu lệnh SQL gói trong một transaction sau</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">1</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">START</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TRANSACTION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">2</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> balance </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> checking </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> customer_id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10233276</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">3</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UPDATE</span><span class="token plain"> checking </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> balance </span><span class="token operator">=</span><span class="token plain"> balance </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">200.00</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> customer_id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10233276</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">4</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UPDATE</span><span class="token plain"> savings </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> balance </span><span class="token operator">=</span><span class="token plain"> balance </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">200.00</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> customer_id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10233276</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">5</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">COMMIT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Transaction được bắt đầu bởi START TRANSACTION và thường được đóng bởi COMMIT (xác nhận thực hiện transaction) hoặc ROLLBACK (trở lại trạng thái trước khi transaction). Nếu như câu lệnh thứ 4 bị lỗi, câu lệnh thứ 3 sẽ được rollback và không có gì xảy ra ảnh hưởng tới dữ liệu cũ.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-4-tính-chất-bảo-toàn-dữ-liệu-trong-cơ-sở-dữ-liệu-quan-hệ">2. 4 tính chất bảo toàn dữ liệu trong cơ sở dữ liệu quan hệ<a class="hash-link" href="#2-4-tính-chất-bảo-toàn-dữ-liệu-trong-cơ-sở-dữ-liệu-quan-hệ" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="ACID" src="/blogs/assets/images/acid-8932890988825239e3b0ba3afb39206a.PNG" width="875" height="489" class="img_ev3q"></p><p>Mỗi một hệ thống cần thoả mãn 4 tính chất ACID để đảm bảo an toàn về dữ liệu</p><ul><li>Atomicity</li></ul><p>Transaction cần hoạt động như một đơn vị công việc. Hoặc là tất cả câu lệnh SQL trong transaction được áp dụng hoặc là không có câu lệnh nào được áp dụng.</p><ul><li>Consistency</li></ul><p>Database cần có tính nhất quán, chỉ được chuyển từ trạng thái nhất quán này đến trạng thái nhất quán khác. Ví dụ ở bên trên, nếu lỗi xảy ra sau khi chạy xong câu thứ 3, tài khoản checking sẽ không bị mất đi 200 tiền khi transaction chưa commit. Tổng tiền ở hai tài khoản trước và sau vẫn giữ nguyên.</p><ul><li>Isolation</li></ul><p>Kết quả của transaction này sẽ vô hình đối với các transaction khác khi transaction này chưa kết thúc, chưa commit. Ví dụ khi transaction 1 đang chạy giữa câu 3 và câu 4 bên trên, một transaction khác tính toán tóm lược lại số dư các tài khoản sẽ vẫn nhìn thấy 200 tiền ở trong tài khoản checking. Khi một transaction chưa commit, không có sự thay đổi nào sẽ ảnh hưởng lên database.</p><ul><li>Durability</li></ul><p>Một khi commit, các thay đổi bởi transaction sẽ tồn tại lâu dài, các sự thay đổi đó cần được ghi chép lại đảm bảo việc dữ liệu không bị mất nếu hệ thống bị lỗi.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-4-isolation-level-trong-môi-trường-có-nhiều-đọc-ghi-đồng-thời">3. 4 isolation level trong môi trường có nhiều đọc ghi đồng thời<a class="hash-link" href="#3-4-isolation-level-trong-môi-trường-có-nhiều-đọc-ghi-đồng-thời" title="Direct link to heading">​</a></h3><p>Có 4 isolation level liên quan tới transaction</p><ul><li>READ UNCOMMITTED</li></ul><p>Ở chế độ này, các transactions có thể nhìn thấy kết quả của các transactions chưa commit khác. Chế độ này hiệu năng không nhanh hơn quá nhiều chế độ khác nhưng dễ gây nhiều vấn đề khi đọc dữ liệu sai.</p><ul><li>READ COMMITTED</li></ul><p>Chế độ mặc định của hầu hết các database (nhưng không phải MySQL), nó sẽ làm mất đi một số đặc tính trong tính Isolation của ACID, transaction này sẽ có thể nhìn thấy các sự thay đổi bởi các transactions khác được commit sau khi transaction này bắt đầu, tuy nhiên sự thay đổi của transaction này vẫn vô hình cho đến khi nó được commit. Điều này có thể gây ra việc hai câu lệnh đọc giống nhau trong một transaction có thể trả về các dữ liệu khác nhau.</p><ul><li>REPEATABLE READ </li></ul><p>Chế độ này là mặc định của MySQL. Nó đảm bảo rằng trong cùng một transaction, các câu lệnh đọc giống nhau sẽ trả về cùng một kết quả giống nhau. Nhưng cũng sẽ có một vấn đề nhỏ xảy ra là nếu ta select một khoảng giá trị, một transaction khác chèn bản ghi mới vào khoảng giá trị đó, ta sẽ nhìn thấy bản ghi mới đó. Các storage engines như InnDB, XtraDB giải quyết vấn đề này bằng việc tạo ra nhiều phiên bản quản lý việc đọc ghi đồng thời.</p><ul><li>SERIALIZABLE</li></ul><p>Chế độ này giải quyết vấn đề đọc một khoảng giá trị bên trên bằng việc chạy các transactions theo một thứ tự. Chế độ này sẽ khoá tất cả row mà nó đọc, rất nhiều timeout và việc khoá xảy ra thường xuyên, tính đọc ghi đồng thời sẽ bị giảm xuống.</p><p><img loading="lazy" alt="Isolation Level" src="/blogs/assets/images/isolation_levels-d31e1dbaccc5a3acbd8a45093e79433c.PNG" width="1318" height="316" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-deadlock-trong-transaction">4. Deadlock trong transaction<a class="hash-link" href="#4-deadlock-trong-transaction" title="Direct link to heading">​</a></h3><p>Deadlock xảy ra khi hai hoặc nhiều các transactions khoá cũng các tài nguyên, tạo ra một vòng tròn phụ thuộc</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">-- Transaction 1 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">START</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TRANSACTION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UPDATE</span><span class="token plain"> StockPrice </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">close</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">45.50</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> stock_id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"> </span><span class="token operator">and</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">date</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> ‘</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span><span class="token plain">’</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UPDATE</span><span class="token plain"> StockPrice </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">close</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">19.80</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> stock_id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"> </span><span class="token operator">and</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">date</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> ‘</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span><span class="token plain">’</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">COMMIT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- Transaction 2 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">START</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TRANSACTION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UPDATE</span><span class="token plain"> StockPrice </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> high </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">20.12</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> stock_id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"> </span><span class="token operator">and</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">date</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> ‘</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">02</span><span class="token plain">’</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UPDATE</span><span class="token plain"> StockPrice </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> high </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">47.20</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> stock_id </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"> </span><span class="token operator">and</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">date</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> ‘</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span><span class="token plain">’</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">COMMIT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Sau khi 2 transaction này chạy xong lệnh đầu tiên, khi chạy lệnh thứ 2. Các bản ghi với id tương ứng của transaction này đang bị khoá bởi transaction khác, cũng như transaction khác bị khoá bởi transaction này. InnoDB sẽ trả về lỗi nếu phát hiện một vòng tròn phụ thuộc. Cách mà InnoDB xử lý deadlock là nó sẽ rollback transaction có ít row bị lock nhất.</p><p><img loading="lazy" alt="Deadlock" src="/blogs/assets/images/deadlock-f575d25cdb29225a1b0ebebaebeaa4ca.JPEG" width="1910" height="1042" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-transaction-logging">5. Transaction logging<a class="hash-link" href="#5-transaction-logging" title="Direct link to heading">​</a></h3><p>Transaction logging khiến việc thực hiện transaction thêm hiệu quả hơn. Thay vì cập nhật thẳng vào bảng ở disk mỗi khi có sự thay đổi nào đó, nó cập nhật vào bảng copy của dữ liệu trong bộ nhớ (in-memory). Sau đó các transaction log sẽ được ghi xuống disk với mode append, hoạt động này rất nhanh vì chỉ yêu cầu I/O tuần tự trong disk, hiệu quả về chi phí hơn, một thời gian sau các thay đổi này mới được áp dụng vào dữ liệu thực ở disk. Bởi vì log này được ghi trên disk nên nó sẽ tồn tại lâu, nếu hệ thống lỗi sau khi ghi transaction log xuống disk nhưng trước khi cập nhật thay đổi vào dữ liệu chính, storage engine vẫn có thể phục hồi các thay đổi đó được.</p><p><img loading="lazy" alt="Transaction Log" src="/blogs/assets/images/transaction_log-ed06e47eebdd08b13fed212c7e595b00.PNG" width="740" height="636" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-autocommit">6. Autocommit<a class="hash-link" href="#6-autocommit" title="Direct link to heading">​</a></h3><p>Mặc định các câu lệnh INSERT, UPDATE, DELETE được gói trong các transaction tạm và được commit ngay khi nó chạy, đây là chế độ AUTOCOMMIT. Để bật chế độ này chạy câu SET AUTOCOMMIT = 1; ngược lại thì SET AUTOCOMMIT = 0. Một số câu lệnh đặc biệt có thể làm transaction commit khi nằm trong một transaction đang mở, ví dụ như các câu lệnh DDL.
Ta có thể cài đặt isolation level cho MySQL bằng việc chạy câu lệnh SET TRANSACTION ISOLATION LEVEL, sau khi chạy thì isolation level này sẽ có hiệu dụng trong các transaction tiếp theo. Ta có thể cài đặt trong file cấu hình cho cả server, hoặc là chỉ set trong phiên làm việc của ta </p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SESSION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TRANSACTION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ISOLATION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LEVEL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">READ</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">COMMITTED</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ta không nên xử lý các bảng có khác storage engine trong cùng một transaction, vì có một số storage engine sẽ không hỗ trợ việc rollback dữ liệu (MyISAM storage engine), nếu có một số lỗi xảy ra trong quá trình thực hiện transaction, sẽ chỉ có một số bảng được rollback lại khiến làm mất đi tính Consistency.</p><p>Bài viết kết thúc tại đây, hẹn gặp các bạn trong các blog tiếp theo.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_u0Nl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/bigdata">Bigdata</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/my-sql">MySQL</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/database">Database</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/data-engineering">Data Engineering</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/transaction">Transaction</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lam1051999/blogs/edit/main/blog/2022-10-06-mysql-transaction/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div class="margin-vert--xl"></div><div class="margin-vert--lg" style="display:flex;align-items:center;justify-content:center"><a class="button button--link" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Flam1051999.github.io%2F%2Fblogs%2Fblog%2Fmysql-series-mysql-transaction&amp;text=I%20just%20read%20%22MySQL%20series%20-%20Transaction%20trong%20MySQL%22%20by%20%40kgajera24" target="_blank" rel="noreferrer noopener" style="display:inline-flex;align-items:center"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 248 204" height="20" width="20" style="margin-right:7px"><g><path fill="#1D9BF0" d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04 C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66 c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64 c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76 c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26 c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"></path></g></svg>Share on Twitter</a></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blogs/blog/mysql-series-mysql-mvcc"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">MySQL series - Multiversion concurrency control</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blogs/blog/mysql-series-mysql-architecture"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">MySQL series - Tổng quan kiến trúc MySQL</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-transaction-là-gì" class="table-of-contents__link toc-highlight">1. Transaction là gì?</a></li><li><a href="#2-4-tính-chất-bảo-toàn-dữ-liệu-trong-cơ-sở-dữ-liệu-quan-hệ" class="table-of-contents__link toc-highlight">2. 4 tính chất bảo toàn dữ liệu trong cơ sở dữ liệu quan hệ</a></li><li><a href="#3-4-isolation-level-trong-môi-trường-có-nhiều-đọc-ghi-đồng-thời" class="table-of-contents__link toc-highlight">3. 4 isolation level trong môi trường có nhiều đọc ghi đồng thời</a></li><li><a href="#4-deadlock-trong-transaction" class="table-of-contents__link toc-highlight">4. Deadlock trong transaction</a></li><li><a href="#5-transaction-logging" class="table-of-contents__link toc-highlight">5. Transaction logging</a></li><li><a href="#6-autocommit" class="table-of-contents__link toc-highlight">6. Autocommit</a></li></ul></div></div></div></div></div><div class="footer-wrapper footer--dark"><div class="container margin-vert--lg"><div style="display:flex;justify-content:center"><div style="max-width:650px">I believe each of us was designed to do certain things, that we have certain duties. Most significantly, since nature intended us to be social creatures, we have duties to our fellow men.</div><div style="margin-left:30px;min-width:169px"><img src="/blogs/img/avatar.jpg" style="height:154px;width:139px"><p style="font-size:0.8em;margin-top:1em">Tran Lam<br>Data Engineer</p></div></div></div><div style="display:flex;justify-content:center"><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blogs/">About</a></li><li class="footer__item"><a class="footer__link-item" href="/blogs/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:lam1051999@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/lamtt1005" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="tel:+84962007024" target="_blank" rel="noopener noreferrer" class="footer__link-item">Phone<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Tran Lam. All content is the property of Tran Lam.</div></div></div></footer></div></div></div>
<script src="/blogs/assets/js/runtime~main.d957ccbe.js"></script>
<script src="/blogs/assets/js/main.784bdc81.js"></script>
</body>
</html>