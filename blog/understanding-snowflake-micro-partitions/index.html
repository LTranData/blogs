<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PK0DHL0FKW"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-PK0DHL0FKW",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Lam Tran" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Lam Tran RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Lam Tran Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous">
<script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7172314318777821" async crossorigin="anonymous"></script><title data-rh="true">Understanding Snowflake micro-partitions</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lam-tran.dev/blog/understanding-snowflake-micro-partitions/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="keywords" content="Data Engineering, Web Development, Blog"><meta data-rh="true" name="title" content="Lam Tran"><meta data-rh="true" property="og:title" content="Understanding Snowflake micro-partitions | Lam Tran"><meta data-rh="true" name="description" content="Understanding Snowflake micro-partitions"><meta data-rh="true" property="og:description" content="Understanding Snowflake micro-partitions"><meta data-rh="true" property="og:image" content="https://lam-tran.dev/assets/images/snowflake-micro-partitions-edc6e519a4607d59ed44eccb953172fd.png"><meta data-rh="true" name="twitter:image" content="https://lam-tran.dev/assets/images/snowflake-micro-partitions-edc6e519a4607d59ed44eccb953172fd.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-12-24T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/lam1051999"><meta data-rh="true" property="article:tag" content="Snowflake,Cloud,Data Platform"><link data-rh="true" rel="icon" href="/img/lt_logo.ico"><link data-rh="true" rel="canonical" href="https://lam-tran.dev/blog/understanding-snowflake-micro-partitions/"><link data-rh="true" rel="alternate" href="https://lam-tran.dev/blog/understanding-snowflake-micro-partitions/" hreflang="en"><link data-rh="true" rel="alternate" href="https://lam-tran.dev/blog/understanding-snowflake-micro-partitions/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GIW3CHZWR8-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.b7fe553f.css">
<link rel="preload" href="/assets/js/runtime~main.8631d92e.js" as="script">
<link rel="preload" href="/assets/js/main.67864cea.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/lt_logo.svg" alt="TL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/lt_logo.svg" alt="TL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Lam Tran</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/understanding-snowflake-micro-partitions/">Understanding Snowflake micro-partitions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/spark-rdd-dataframe-dataset/">Differences between Spark RDD, Dataframe and Dataset</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-is-memory-managed-in-spark/">How Is Memory Managed In Spark?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/state-management-react/">State Management In React</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mini-spark3-authorizer-part-2/">Authorize Spark 3 SQL With Apache Ranger Part 2 - Integrate Spark SQL With Ranger</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mini-spark3-authorizer-part-1/">Authorize Spark 3 SQL With Apache Ranger Part 1 - Ranger installation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/spark-catalyst-optimizer-and-spark-session-extension/">Spark Catalyst Optimizer And Spark Session Extension</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-indexing/">MySQL series - Indexing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-mvcc/">MySQL series - Multiversion concurrency control</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-transaction/">MySQL series - Transaction In MySQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-architecture/">MySQL series - MySQL Architecture Overview</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/spark-kafka-docker/">Create A Data Streaming Pipeline With Spark Streaming, Kafka And Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/spark-cluster-docker/">Create A Standalone Spark Cluster With Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/avl-tree/">AVL Tree, AVL Sorting Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/binarysearch-tree/">Binary Search Tree</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sorting-algorithms/">Fundamental Sorting Algorithms</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/peak-finding/">Peak Finding Algorithm</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">Understanding Snowflake micro-partitions</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2024-12-24T00:00:00.000Z" itemprop="datePublished">December 24, 2024</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lam1051999.png" alt="Lam Tran"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lam Tran</span></a></div><small class="avatar__subtitle" itemprop="description">Data Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://lam-tran.dev/assets/images/snowflake-micro-partitions-edc6e519a4607d59ed44eccb953172fd.png"><div id="post-content" class="markdown" itemprop="articleBody"><p>Snowflake is one of the most popular data warehouse solutions nowaday because of the various features that it can provide you to build a complete data platform. Understanding the Snowflake storage layer not only helps us to have a deep dive into how it organizes the data under the hood but it is also crucial for performance optimization of your queries.</p><p><img loading="lazy" alt="banner image" src="/assets/images/snowflake-micro-partitions-edc6e519a4607d59ed44eccb953172fd.png" width="1377" height="734" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-partitioning-in-traditional-data-lake">1. Partitioning in traditional Data Lake<a class="hash-link" href="#1-partitioning-in-traditional-data-lake" title="Direct link to heading">​</a></h2><p>When working with traditional Data Lake solution such as Hadoop, we often organized partitions of tables in hierarchical folder structure with partition column as subfolders, data stored in files​.</p><p><img loading="lazy" alt="traditional partitioning" src="/assets/images/traditional-partitioning-9bcebf49f06b854f23fa4994540ff97b.png" width="1350" height="584" class="img_ev3q"></p><p>Although this approach is easy for visual exploration and query, there are many drawbacks</p><ul><li>We need to predefine the partition columns for the table​ and always be mindful in table design and partitions selection​ at the first place. </li></ul><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> company_revenue </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    id </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTEGER</span><span class="token plain"> </span><span class="token operator">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    revenue </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">DECIMAL</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">38</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">15</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">NOT</span><span class="token plain"> </span><span class="token boolean">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">date</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">INTEGER</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Overhead of maintenance: adding more partitioned columns to the table requires whole table rewrite and metadata changes, the more partitions the more metadata size and management burden,...​</li><li>Low performance when filtering on non-partitioned columns​</li><li>Suffer from the data skewness problem leading to low performance query even with partitioned data​</li><li>Not having the best query pushdown and pruning​ since there are likely only partition columns that can be pruned</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-snowflake-micro-partitions-overview">2. Snowflake micro-partitions overview<a class="hash-link" href="#2-snowflake-micro-partitions-overview" title="Direct link to heading">​</a></h2><p>Snowflake Data Platform implements a powerful and unique form of partitioning, called micro-partitioning. Unlike traditional static partitioning schemes that require manual partition key definition, Snowflake&#x27;s micro-partitions are automatically created during data ingestion based on natural sort order and file size optimization. This approach enables partition pruning, data clustering, and autonomous optimization without the overhead of partition management or the risk of partition skew.</p><ul><li>Tables in Snowflake are divided into micro partitions automatically without overhead of manual maintenance​</li></ul><p><img loading="lazy" alt="table micro partitions" src="/assets/images/snowflake-micro-partitions-edc6e519a4607d59ed44eccb953172fd.png" width="1377" height="734" class="img_ev3q"></p><ul><li>Each micro partition contains 50 -&gt; 500 MB of uncompressed data (~16 MB of compressed data), efficient for query pruning​. There can be overlap between micro partitions in the value ranges it stores, so that they can be similar in size, data volume, to reduce data skewness problem​</li></ul><p><img loading="lazy" alt="micro partitions size" src="/assets/images/micro-partitions-size-e509e6adb9c9e79dbc983bd3df07f5cd.png" width="2288" height="1544" class="img_ev3q"></p><ul><li>Data stored in columnar oriented format for efficient query projection​. Snowflake decides the most efficient compression algorithm to use for each column based on the column datatype and statistics​</li></ul><p><img loading="lazy" alt="columnar oriented format" src="/assets/images/columnar-oriented-format-59f90b02bebb57fec64d671e6032ea99.png" width="2266" height="1406" class="img_ev3q"></p><p>Snowflake stored metadata of each micro partition​</p><ul><li>The range of values for each of the columns​</li><li>The number of distinct values​</li><li>Additional properties used for both optimization and efficient query processing​</li></ul><p>This information can help the query optimizer calculate the cost of each query plan and choose the best plan for processing the work units submitted to the virtual warehouse cluster.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-how-do-snowflake-perform-table-updates">3. How do Snowflake perform table updates?​<a class="hash-link" href="#3-how-do-snowflake-perform-table-updates" title="Direct link to heading">​</a></h2><p>Snowflake micro partitions are immutable, they will not be modified once it is created. Data updates on the table will result in new micro partition creation, not modifying existing ones, with the changes applied compared with the old ones. The old micro partitions will either be destroyed immediately or remain for a certain amount of time based on the <code>DATA_RETENTION_TIME_IN_DAYS</code> parameter set on the table.</p><p>The immutable characteristic of micro partitions is also the reason that makes Time-Travel possible and easy to manage​ because of the ability to traverse back to the old version of data.</p><p><img loading="lazy" alt="insert update delete" src="/assets/images/insert-update-delete-f6a9f5d3646ed74bf237b455efe4d670.png" width="3418" height="2933" class="img_ev3q"></p><ul><li>If we insert new records into the table, new micro partitions will be created</li><li>If we update or delete certain records of the table, old micro partitions will be obsoleted and new micro partitions will be created with the changes applied</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-clustering-information-of-micro-partitions">4. Clustering information of micro partitions<a class="hash-link" href="#4-clustering-information-of-micro-partitions" title="Direct link to heading">​</a></h2><p>During data ingestion into Snowflake tables, the platform automatically generates and maintains clustering metadata at the micro-partition level. This metadata contains statistical information about value distributions and data boundaries for each column within each micro-partition. </p><p>The query optimizer then leverages this fine-grained metadata to implement partition pruning, eliminating non-qualifying micro-partitions from the scan path based on query predicates.</p><p>The number of micro partitions that are needed to scan depends dramatically on how the micro partitions are organized. There are 2 pieces of information that can show how well the table is clustered</p><ul><li>Clustering Depth: the average depth (1 or greater) of the overlapping micro-partitions for specified columns in a table</li><li>Clustering Width: The number of micro-partitions containing values that overlap with each other</li></ul><p><img loading="lazy" alt="clustering depth" src="/assets/images/clustering-depth-06bc0bb75825f17c4d751f8568e275a7.png" width="1340" height="813" class="img_ev3q"></p><p>The smaller the clustering metrics are, the better clustered the table is with regards to the specified columns.​ Hence, the query that has filter/join conditions on that column will have better performance compare to the query on other columns.</p><p>For above picture, suppose that we have query <code>SELECT * FROM table_a WHERE column_a = &#x27;h&#x27;</code>, the scenario that <code>clustering depth = 5</code>, we will need to scan all 5 partitions to get the result. Otherwise, <code>clustering depth = 1</code>, we will only need to scan the partition that contains value range from <code>e -&gt; j</code>.</p><p>For checking the clustering information, use <a href="https://docs.snowflake.com/en/sql-reference/functions/system_clustering_information" target="_blank" rel="noopener noreferrer">SYSTEM$CLUSTERING_INFORMATION</a> function.</p><p><img loading="lazy" alt="clustering information" src="/assets/images/clustering-information-0a4c7fe129ebbe4b5abab9cd75ec1752.png" width="2778" height="1548" class="img_ev3q"></p><p>In above case, try adding <code>DATE(INSERTED_TIME)</code> filter in every of your queries will boost the performance of READ query as a whole.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-clustered-key-and-tips">5. Clustered key and tips​<a class="hash-link" href="#5-clustered-key-and-tips" title="Direct link to heading">​</a></h2><p>To overcome the problem that a certain set of columns of the table have bad clustering information, Snowflake introduces the Clustering key concept. Normally, it is similar to indexes in an operational database. The clustering key in Snowflake is a subset of columns in a table (or expressions on a table) that are explicitly designated to co-locate the data in the table in the same micro-partitions​</p><p>Clustering key often provides the most benefits when​</p><ul><li>Applied on the table that has infrequent DML (less re-clustering operation needed)​</li><li>Columns that are most actively used in selective filters​</li><li>Columns frequently used in join predicates​</li><li>Columns that have enough (medium) cardinality (number of distinct values of that column/number of records in the table) to not only enable effective pruning but also effectively group rows in the same micro-partitions​</li></ul><p>For the <code>SEGMENT_CODE</code> column of the previous section table, we can put the clustering key in order to re-organize the data distribution and boost the performance of the query using the filter/join conditions on that column.</p><p>Be mindful that <a href="https://www.snowflake.com/legal-files/CreditConsumptionTable.pdf" target="_blank" rel="noopener noreferrer">Clustering key cost = 2 credits = 8$​</a>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-real-life-use-case">6. Real life use case<a class="hash-link" href="#6-real-life-use-case" title="Direct link to heading">​</a></h2><p>Imagine you have a very large table in Snowflake with billions of records, you are required to remove 90% of the records from the table as part of the data archival process</p><ul><li>Easy 😝 just <code>DELETE FROM &lt;table&gt; WHERE &lt;dead_condition&gt;;​</code></li><li>Wait 🤔 did you forget anything important? Snowflake will try to search for the eligible micro partitions and create a new micro partition from the old one. It will destroy the old version immediately or not based on the <code>DATA_RETENTION_TIME_IN_DAYS</code> we set on the table​. In the worst case, the records that need to be deleted are located in all table micro partitions then your query will scan the whole table and recreate lots of micro partitions​.</li><li>There need to be a better solution right? 😵‍💫​</li><li>Wait 😲 query 10% records that have <code>&lt;suriving_condition&gt;</code> will be a lot faster right? So we can do​</li></ul><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">new_table</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">table</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">suriving_condition</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">​</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">table</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">table_backup</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">​</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">new_table</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">RENAME</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">table</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">​</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLE</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">table_backup</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">​</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With the above approach, 1st query will be much faster when it scans only 10% of the data​. 2nd, 3rd, 4th are metadata queries so they are also fast​. Using the trick, you will save a lot of time and Snowflake credits. Depending on the size of your data, the cost saving can be tens of times.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7-references">7. References<a class="hash-link" href="#7-references" title="Direct link to heading">​</a></h2><p><a href="https://docs.snowflake.com/en/user-guide/tables-clustering-micropartitions" target="_blank" rel="noopener noreferrer">Micro-partitions &amp; Data Clustering</a></p><p><a href="https://docs.snowflake.com/en/user-guide/data-time-travel" target="_blank" rel="noopener noreferrer">Understanding &amp; using Time Travel</a></p><p><a href="https://www.linkedin.com/pulse/impact-dml-operations-micro-partitions-snowflake-minzhen-yang/" target="_blank" rel="noopener noreferrer">The Impact of DML Operations with micro-partitions in Snowflake</a></p><p><a href="https://docs.snowflake.com/en/user-guide/tables-clustering-keys" target="_blank" rel="noopener noreferrer">Clustering Keys &amp; Clustered Tables</a></p><p><a href="https://www.snowflake.com/legal-files/CreditConsumptionTable.pdf" target="_blank" rel="noopener noreferrer">Snowflake Service Consumption Table</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_u0Nl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/snowflake">Snowflake</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cloud">Cloud</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/data-platform">Data Platform</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lam1051999/blogs/edit/main/blog/2024-12-24-understanding-snowflake-micro-partitions/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div class="margin-vert--xl"></div><div class="margin-vert--lg" style="display:flex;align-items:center;justify-content:center"><a aria-label="Twitter" class="button button--link" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Flam-tran.dev%2Fblog%2Funderstanding-snowflake-micro-partitions%2F&amp;text=I%20just%20read%20%22Understanding%20Snowflake%20micro-partitions%22%20by%20%40lamtt1005" target="_blank" rel="noreferrer noopener" style="display:inline-flex;align-items:center"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 248 204" height="20" width="20" style="margin-right:7px"><g><path fill="#1D9BF0" d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04 C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66 c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64 c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76 c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26 c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"></path></g></svg>Share on Twitter</a></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/spark-rdd-dataframe-dataset/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Differences between Spark RDD, Dataframe and Dataset</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-partitioning-in-traditional-data-lake" class="table-of-contents__link toc-highlight">1. Partitioning in traditional Data Lake</a></li><li><a href="#2-snowflake-micro-partitions-overview" class="table-of-contents__link toc-highlight">2. Snowflake micro-partitions overview</a></li><li><a href="#3-how-do-snowflake-perform-table-updates" class="table-of-contents__link toc-highlight">3. How do Snowflake perform table updates?​</a></li><li><a href="#4-clustering-information-of-micro-partitions" class="table-of-contents__link toc-highlight">4. Clustering information of micro partitions</a></li><li><a href="#5-clustered-key-and-tips" class="table-of-contents__link toc-highlight">5. Clustered key and tips​</a></li><li><a href="#6-real-life-use-case" class="table-of-contents__link toc-highlight">6. Real life use case</a></li><li><a href="#7-references" class="table-of-contents__link toc-highlight">7. References</a></li></ul></div></div></div></div></div><div class="footer-wrapper footer--dark"><div class="container margin-vert--lg"><div style="display:flex;justify-content:center"><div style="max-width:650px">I am a highly motivated and passionate data engineer. I often work with Python, Scala, and Java and use the latest big data technologies to solve problems, making tools to improve my and others&#x27; work productivity. I am currently certified with<div style="margin-top:10px"><a aria-label="snowpro-core-certification" target="_blank" rel="noreferrer noopener" href="https://achieve.snowflake.com/572af38a-0a3d-4fbf-959a-1e1dcf36a113"><img alt="Snowpro Core Certification" loading="lazy" style="height:50px;width:50px" src="/img/COF-C02.png"></a><a aria-label="aws-certified-solutions-architect-associate" target="_blank" rel="noreferrer noopener" href="https://www.credly.com/badges/2fe47770-22a6-4a16-8849-3f4c5a170fae/public_url"><img alt="AWS Certified Solutions Architect - Associate" loading="lazy" style="height:50px;width:50px;margin-left:5px" src="/img/SAA-C03.png"></a></div></div><div style="margin-left:30px;min-width:162px"><img alt="avatar" loading="lazy" src="/img/avatar.jpg" style="height:130px;width:136px"><p style="font-size:0.8em;margin-top:1em">Lam Tran<br>Data Engineer</p></div></div></div><div style="display:flex;justify-content:center"><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">About</a></li><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:lam1051999@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/lamtt1005/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="tel:+84962007024" target="_blank" rel="noopener noreferrer" class="footer__link-item">Phone<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/lam1051999/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Lam Tran. Powered by <a aria-label="Docusaurus" target="_blank" rel="noreferrer noopener" style="color:white;font-weight:bold;" href="https://docusaurus.io/">Docusaurus 2</a></div></div></div></footer></div></div></div>
<script src="/assets/js/runtime~main.8631d92e.js"></script>
<script src="/assets/js/main.67864cea.js"></script>
</body>
</html>