<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PK0DHL0FKW"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-PK0DHL0FKW",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Lam Tran" href="/blogs/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/blogs/blog/rss.xml" title="Lam Tran RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blogs/blog/atom.xml" title="Lam Tran Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">Spark Catalyst Optimizer And Spark Session Extension</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lam1051999.github.io//blogs/blog/spark-catalyst-optimizer-and-spark-session-extension"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Spark Catalyst Optimizer And Spark Session Extension | Lam Tran"><meta data-rh="true" name="description" content="Spark catalyst optimizer is located at the core of Spark SQL with the purpose of optimizing structured queries expressed in SQL or through DataFrame/Dataset APIs, minimizing application running time and costs. When using Spark, often people see the catalyst optimizer as a black box, when we assume that it works mysteriously without really caring what happens inside it. In this article, I will go in depth of its logic, its components, and how the Spark session extension participates to change the Catalyst&#x27;s plans."><meta data-rh="true" property="og:description" content="Spark catalyst optimizer is located at the core of Spark SQL with the purpose of optimizing structured queries expressed in SQL or through DataFrame/Dataset APIs, minimizing application running time and costs. When using Spark, often people see the catalyst optimizer as a black box, when we assume that it works mysteriously without really caring what happens inside it. In this article, I will go in depth of its logic, its components, and how the Spark session extension participates to change the Catalyst&#x27;s plans."><meta data-rh="true" property="og:image" content="https://lam1051999.github.io//blogs/assets/images/spark-catalyst-optimizer-03f0f2a4cb6e0c86499aaa51ba69b065.JPG"><meta data-rh="true" name="twitter:image" content="https://lam1051999.github.io//blogs/assets/images/spark-catalyst-optimizer-03f0f2a4cb6e0c86499aaa51ba69b065.JPG"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-01-07T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/lam1051999"><meta data-rh="true" property="article:tag" content="Bigdata,Spark,Apache"><link data-rh="true" rel="icon" href="/blogs/img/lt_logo_2.svg"><link data-rh="true" rel="canonical" href="https://lam1051999.github.io//blogs/blog/spark-catalyst-optimizer-and-spark-session-extension"><link data-rh="true" rel="alternate" href="https://lam1051999.github.io//blogs/blog/spark-catalyst-optimizer-and-spark-session-extension" hreflang="en"><link data-rh="true" rel="alternate" href="https://lam1051999.github.io//blogs/blog/spark-catalyst-optimizer-and-spark-session-extension" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KPAEHOL9XK-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/blogs/assets/css/styles.2e718d97.css">
<link rel="preload" href="/blogs/assets/js/runtime~main.98e4ac19.js" as="script">
<link rel="preload" href="/blogs/assets/js/main.1d670f4e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/blogs/"><div class="navbar__logo"><img src="/blogs/img/lt_logo_2.svg" alt="TL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/blogs/img/lt_logo_2.svg" alt="TL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Lam Tran</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blogs/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blogs/blog">Blog</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/state-management-react">State Management In React</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blogs/blog/spark-catalyst-optimizer-and-spark-session-extension">Spark Catalyst Optimizer And Spark Session Extension</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-indexing">MySQL series - Indexing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-mvcc">MySQL series - Multiversion concurrency control</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-transaction">MySQL series - Transaction In MySQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/mysql-series-mysql-architecture">MySQL series - MySQL Architecture Overview</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/spark-kafka-docker">Create A Data Streaming Pipeline With Spark Streaming, Kafka And Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/spark-cluster-docker">Create A Standalone Spark Cluster With Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/avl-tree">AVL Tree, AVL Sorting Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/binarysearch-tree">Binary Search Tree</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/sorting-algorithms">Fundamental Sorting Algorithms</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blogs/blog/peak-finding">Peak Finding Algorithm</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">Spark Catalyst Optimizer And Spark Session Extension</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2023-01-07T00:00:00.000Z" itemprop="datePublished">January 7, 2023</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lam1051999.png" alt="Lam Tran"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lam Tran</span></a></div><small class="avatar__subtitle" itemprop="description">Data Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://lam1051999.github.io//blogs/assets/images/spark-catalyst-optimizer-03f0f2a4cb6e0c86499aaa51ba69b065.JPG"><div id="post-content" class="markdown" itemprop="articleBody"><p>Spark catalyst optimizer is located at the core of Spark SQL with the purpose of optimizing structured queries expressed in SQL or through DataFrame/Dataset APIs, minimizing application running time and costs. When using Spark, often people see the catalyst optimizer as a black box, when we assume that it works mysteriously without really caring what happens inside it. In this article, I will go in depth of its logic, its components, and how the Spark session extension participates to change the Catalyst&#x27;s plans.</p><p><img loading="lazy" alt="spark catalyst optimizer" src="/blogs/assets/images/spark-catalyst-optimizer-03f0f2a4cb6e0c86499aaa51ba69b065.JPG" width="1280" height="720" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-treenode">1. TreeNode<a class="hash-link" href="#1-treenode" title="Direct link to heading">​</a></h3><p>The main components in Catalyst are represented as tree nodes, which are inherited from class <code>TreeNode</code>, or its subclasses. Class <code>TreeNode</code> has a set of child nodes with the attribute <code>children</code>, datatype <code>Seq[BaseType]</code>, therefore, one <code>TreeNode</code> can have 0 or more child nodes. These objects are immutable and manipulated using functional transformations, making the debug optimizer easier and parallel operations more predictable.</p><p>The two important classes are <code>LogicalPlan</code> and <code>SparkPlan</code> are both subclasses of <code>QueryPlan</code>, the class inherits directly from <code>TreeNode</code>. In the above Catalyst diagram, the first 3 components are logical plans, the nodes in the logical plan are usually algebraic operators such as <code>Join</code>, <code>Filter</code>, <code>Project</code>,... the two components behind are spark plans (physical plans), nodes are usually low-level operators like <code>ShuffledHashJoinExec</code>, <code>SortMergeJoinExec</code>, <code>BroadcastHashJoinExec</code>, <code>FileSourceScanExec</code>,...</p><p>Leaf nodes will read data from sources, storage, memory ,... and the root node of the tree is the outermost operator and returns the result of the calculation.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-rules">2. Rules<a class="hash-link" href="#2-rules" title="Direct link to heading">​</a></h3><p>To manipulate the TreeNode we use rules, rules are actually components that transforms the tree, from one tree to another. In the rule, we implement the logic that transforms the TreeNode, which often uses the pattern matching in Scala to find the corresponding matches in its subtree and replace it with other constructs. Trees provide transformation functions that can apply this pattern matching to transform trees like <code>transform</code>, <code>transformDown</code>, <code>transformUp</code>,...</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">catalyst</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">trees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * Returns a copy of this node where `rule` has been recursively applied to the tree.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * When `rule` does not apply to a given node it is left unchanged.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * Users should not expect a specific directionality. If a specific directionality is needed,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * transformDown or transformUp should be used.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param rule the function used to transform this nodes children</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> transform</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token operator">:</span><span class="token plain"> PartialFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> BaseType </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    transformDown</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * Returns a copy of this node where `rule` has been recursively applied to the tree.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * When `rule` does not apply to a given node it is left unchanged.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * Users should not expect a specific directionality. If a specific directionality is needed,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * transformDown or transformUp should be used.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param rule   the function used to transform this nodes children</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param cond   a Lambda expression to prune tree traversals. If `cond.apply` returns false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *               on a TreeNode T, skips processing T and its subtree; otherwise, processes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *               T and its subtree recursively.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param ruleId is a unique Id for `rule` to prune unnecessary tree traversals. When it is</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *               UnknownRuleId, no pruning happens. Otherwise, if `rule` (with id `ruleId`)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *               has been marked as in effective on a TreeNode T, skips processing T and its</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *               subtree. Do not pass it if the rule is not purely functional and reads a</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *               varying initial state for different invocations.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> transformWithPruning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cond</span><span class="token operator">:</span><span class="token plain"> TreePatternBits </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ruleId</span><span class="token operator">:</span><span class="token plain"> RuleId </span><span class="token operator">=</span><span class="token plain"> UnknownRuleId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token operator">:</span><span class="token plain"> PartialFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">:</span><span class="token plain"> BaseType </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    transformDownWithPruning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cond</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ruleId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * Returns a copy of this node where `rule` has been recursively applied to it and all of its</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * children (pre-order). When `rule` does not apply to a given node it is left unchanged.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param rule the function used to transform this nodes children</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> transformDown</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token operator">:</span><span class="token plain"> PartialFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> BaseType </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    transformDownWithPruning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">AlwaysProcess</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> UnknownRuleId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> transformDownWithPruning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cond</span><span class="token operator">:</span><span class="token plain"> TreePatternBits </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ruleId</span><span class="token operator">:</span><span class="token plain"> RuleId </span><span class="token operator">=</span><span class="token plain"> UnknownRuleId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token operator">:</span><span class="token plain"> PartialFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">:</span><span class="token plain"> BaseType </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/* More code */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> transformUp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token operator">:</span><span class="token plain"> PartialFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> BaseType </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    transformUpWithPruning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">AlwaysProcess</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> UnknownRuleId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> transformUpWithPruning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cond</span><span class="token operator">:</span><span class="token plain"> TreePatternBits </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ruleId</span><span class="token operator">:</span><span class="token plain"> RuleId </span><span class="token operator">=</span><span class="token plain"> UnknownRuleId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rule</span><span class="token operator">:</span><span class="token plain"> PartialFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> BaseType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token operator">:</span><span class="token plain"> BaseType </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/* More code */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/* ... */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here is a simple example of using transform and partn matching to transform one Treenode to another</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> </span><span class="token namespace">com</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">tranlam</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">catalyst</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">expressions</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> BinaryOperator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Expression</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> IntegerLiteral</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Multiply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Subtract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> UnaryMinus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SparkConf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SparkSession</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">object</span><span class="token plain"> TestTransform </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> sparkConf </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> SparkConf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">setAppName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;test_transform&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">setMaster</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;local[*]&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> spark </span><span class="token operator">=</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sparkConf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getOrCreate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> firstExpr</span><span class="token operator">:</span><span class="token plain"> Expression </span><span class="token operator">=</span><span class="token plain"> UnaryMinus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Multiply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Subtract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Literal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">11</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Subtract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Literal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">9</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> transformed</span><span class="token operator">:</span><span class="token plain"> Expression </span><span class="token operator">=</span><span class="token plain"> firstExpr transformDown </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> BinaryOperator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">l</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">l</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> IntegerLiteral</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> i </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> IntegerLiteral</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    println</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">firstExpr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// -((11 - 2) * (9 - 5))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    println</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">transformed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// -((1 + 0) + (1 + 5))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation id function" style="color:rgb(80, 250, 123)">s</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">&quot;SELECT </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token string-interpolation interpolation expression">firstExpr</span><span class="token string-interpolation interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string-interpolation interpolation expression">sql</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-interpolation id function" style="color:rgb(80, 250, 123)">s</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">&quot;SELECT </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token string-interpolation interpolation expression">transformed</span><span class="token string-interpolation interpolation expression punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string-interpolation interpolation expression">sql</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above example, the transformDown function is used, which traverses the nodes of a tree and uses pattern matching to return a different result. If the node is a binary operator like Multiply, Subtract, it will convert to Add. If node is an integer constant greater than 5, it will change to 1, constant less than 5 will change to 0, a constant of 5 will keep the same value.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-catalyst-operations-in-spark-sql">3. Catalyst Operations in Spark SQL<a class="hash-link" href="#3-catalyst-operations-in-spark-sql" title="Direct link to heading">​</a></h3><p>Spark Catalyst uses tree transformations in four main phases: (1) logical plan analysis to traverse the relations in that plan, (2) logical plan optimization, (3) physical planning, (4) code generation to compile the query into Java bytecode.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-parsing-and-analyzing">3.1. Parsing and Analyzing<a class="hash-link" href="#31-parsing-and-analyzing" title="Direct link to heading">​</a></h4><p><img loading="lazy" alt="spark catalyst parseing analyzing" src="/blogs/assets/images/catalyst-pipeline-parsing-analyzing-434229ee4a24f7a81d885d239a4ea344.PNG" width="642" height="519" class="img_ev3q"></p><p>In this phase, Catalyst rules and Catalog objects will be used by Spark SQL to check if the relations in our query exist or not, relation properties such as columns, column names are also checked, the syntax of the query is examined and then resolve those relations.</p><p>For example, looking at the query plan below, Spark SQL will first transform the query into a parsed tree called an &quot;unresolved logical plan&quot; with undefined attributes and datatypes, not yet assigned to a specific table (or alias). Then it will</p><ul><li>Search for relation by name from Catalog object.</li><li>Mapping properties as columns of input with found relations.</li><li>Decide which properties should point to the same value to assign it a unique ID (for the purpose of later optimizing expressions like <code>col = col</code>).</li><li>Cast expressions of a specific datatype (for example, we won&#x27;t know the return datatype of <code>col * 2</code> until col is resolved and the datatype is determined).</li></ul><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">describe_abc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"> Parsed Logical </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Plan</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Project [*]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">+- &#x27;</span><span class="token plain">UnresolvedRelation </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> describe_abc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"> Analyzed Logical </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Plan</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">id: </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name: string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Project </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">id</span><span class="token comment" style="color:rgb(98, 114, 164)">#5833, name#5834]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">+</span><span class="token operator">-</span><span class="token plain"> SubqueryAlias spark_catalog</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">describe_abc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token operator">+</span><span class="token operator">-</span><span class="token plain"> Relation test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">describe_abc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">id</span><span class="token comment" style="color:rgb(98, 114, 164)">#5833,name#5834] parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"> Optimized Logical </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Plan</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Relation test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">describe_abc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">id</span><span class="token comment" style="color:rgb(98, 114, 164)">#5833,name#5834] parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"> Physical </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">Plan</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> ColumnarToRow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">+</span><span class="token operator">-</span><span class="token plain"> FileScan parquet test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">describe_abc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">id</span><span class="token comment" style="color:rgb(98, 114, 164)">#5833,name#5834] Batched: true, DataFilters: [], Format: Parquet, Location: InMemoryFileIndex(1 paths)[hdfs://bigdataha/user/hive/warehouse/test.db/describe_abc], PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;id:int,name:string&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-logical-plan-optimizations">3.2. Logical plan optimizations<a class="hash-link" href="#32-logical-plan-optimizations" title="Direct link to heading">​</a></h4><p><img loading="lazy" alt="spark LP optimization" src="/blogs/assets/images/catalyst-pipeline-LP-optimization-f6ab83bcb7f4fe16849cb54ee255ac1b.PNG" width="642" height="519" class="img_ev3q"></p><p>Catalyst applies standard optimization rules to the logical plan analyzed in the previous step, with cached data. This section includes rules like</p><ul><li>Constant folding: removes expressions that compute a value that we can define before the code runs, for example, with the expression <code>y = x * 2 * 2</code>, compiler will not generate 2 multiply instructions, it will first replace the constants before the values ​​can be computed <code>y = x * 4</code>.</li><li>Predicate pushdown: push down parts of the query to where the data is stored, filter large amounts of data, improve network traffic.</li><li>Projection: read only selected columns, less columns will be passed from the storage to Spark, significantly efficient with columnar file format such as Parquet.</li><li>Boolean expression simplification: eg. A and (A or B) = A(A+B) = A.A + A.B = A + A.B = A.(1+B) = A</li><li>Many other rules,…</li></ul><p>Spark&#x27;s Catalyst optimizer will include batches of rules, some of which can exist in multiple batches. Usually these batch rules will be run once on that plan, however, there are some batches that will run repeatedly until a certain number of passes.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33-physical-planning">3.3. Physical planning<a class="hash-link" href="#33-physical-planning" title="Direct link to heading">​</a></h4><p><img loading="lazy" alt="spark PP planning" src="/blogs/assets/images/catalyst-pipeline-PP-planning-965d236e9af5638f8e5b6a15278a4331.PNG" width="642" height="519" class="img_ev3q"></p><p>Spark SQL takes a logical plan and generates one or more physical plans, then it chooses the appropriate physical plan based on the cost models. Cost models typically rely on relational statistics, quantifying statistics flowing into a node in a TreeNode such as</p><ul><li>Size of data flowing into node.</li><li>Number of records per table.</li><li>Statistical indexes related to columns such as: number of distinct values and nulls, minimum and maximum value, average and maximum length of the values, an equi-height histogram of the values,...</li></ul><p>Some Spark SQL approaches to this cost model</p><ul><li>Size-only approach: only uses statistics about the physical size of the data flowing into the node, also take the number of records index in some cases.</li><li>Cost-based approach: statistics related to column level information for Aggregate, Filter, Join, Project nodes (note, cost-based approach is only applicable to nodes of this type, with other types of nodes, it will revert to using the size-only approach), improving the size and number of records for those nodes.</li></ul><p>The cost-based approach is chosen if we set <code>spark.sql.cbo.enabled=true</code>. Besides, table and column statistics also need to be collected so that Spark can calculate based on it, by running <strong><a href="https://spark.apache.org/docs/latest/sql-ref-syntax-aux-analyze-table.html" target="_blank" rel="noopener noreferrer">ANALYZE</a></strong></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="34-code-generation">3.4. Code generation<a class="hash-link" href="#34-code-generation" title="Direct link to heading">​</a></h4><p><img loading="lazy" alt="spark codegen" src="/blogs/assets/images/catalyst-pipeline-codegen-4303b28d4eb24d57d52bc29fca45a337.PNG" width="642" height="519" class="img_ev3q"></p><p>After selecting the right physical plan to run, Catalyst will compile a tree of plans that support codegen into a single Java function, to Java bytecode to run on drivers and executors. This codegen greatly improves running speed when Spark SQL often works on in-memory datasets, data processing is often tied to the CPU. Catalyst relies on a Scala feature, quasiquotes, to simplify this part of the codegen (quasiquotes allow building abstract syntax trees (ASTs), which then input the Scala compiler to generate bytecode).</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-spark-session-extension">4. Spark session extension<a class="hash-link" href="#4-spark-session-extension" title="Direct link to heading">​</a></h3><p>Spark session extension is an extension of Spark that allows us to customize parts of the Catalyst optimizer so that it works in each of our contexts.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-custom-parser-rule">4.1. Custom parser rule<a class="hash-link" href="#41-custom-parser-rule" title="Direct link to heading">​</a></h4><p>As shown above, initially our query will have to go through the parsing set to check the validity of the query. Spark provides an interface that we can implement at this stage <code>ParserInterface</code></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">catalyst</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">parser</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@DeveloperApi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">trait</span><span class="token plain"> ParserInterface </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to a LogicalPlan&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parsePlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> LogicalPlan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to an Expression&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parseExpression</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> Expression</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to a TableIdentifier&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parseTableIdentifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> TableIdentifier</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to a FunctionIdentifier&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parseFunctionIdentifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> FunctionIdentifier</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to a multi-part identifier&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parseMultipartIdentifier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to a schema&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parseTableSchema</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> StructType</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to a DataType&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parseDataType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> DataType</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token annotation punctuation" style="color:rgb(248, 248, 242)">@throws</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">ParseException</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Text cannot be parsed to a LogicalPlan&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> parseQuery</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sqlText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> LogicalPlan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will implement that interface and inject this rule into Spark job as follows</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> CustomerParserRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sparkSession</span><span class="token operator">:</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> delegateParser</span><span class="token operator">:</span><span class="token plain"> ParserInterface</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> ParserInterface </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">/* Overwrite those methods here */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> customerParserRuleFunc</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">extensionBuilder</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  extensionBuilder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">injectParser</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CustomerParserRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-custom-analyzer-rule">4.2. Custom analyzer rule<a class="hash-link" href="#42-custom-analyzer-rule" title="Direct link to heading">​</a></h4><p>Analyzer rule includes several types of rules such as resolution rule, check rule. These rules are injected through functions</p><ul><li><code>injectResolutionRule</code>: inject our rules for the resolution phase.</li><li><code>injectPostHocResolutionRule</code>: run our rules after the resolution phase.</li><li><code>injectCheckRule</code>: add rules to check some logic of logical plans, for example, we want to check business logic, or check which rules have finished running,...</li></ul><p>To inject resolution rule, we extend an abstract class of Spark <code>Rule[LogicalPlan]</code></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> CustomAnalyzerResolutionRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sparkSession</span><span class="token operator">:</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> Rule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">plan</span><span class="token operator">:</span><span class="token plain"> LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> LogicalPlan </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/* Code for resolution rule */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> customAnalyzerResolutionRuleFunc</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">extensionBuilder</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  extensionBuilder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">injectResolutionRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CustomAnalyzerResolutionRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To inject check rule, we inherit the class <code>Function1[LogicalPlan, Unit]</code></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> CustomAnalyzerCheckRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sparkSession</span><span class="token operator">:</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">LogicalPlan </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">plan</span><span class="token operator">:</span><span class="token plain"> LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/* Code for check rule */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> customAnalyzerCheckRuleFunc</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">extensionBuilder</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  extensionBuilder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">injectCheckRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CustomAnalyzerCheckRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43-custom-optimization">4.3. Custom optimization<a class="hash-link" href="#43-custom-optimization" title="Direct link to heading">​</a></h4><p>To customize the logical plan optimization phase, we will inherit the abstract class <code>Rule[LogicalPlan]</code></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> CustomOptimizer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sparkSession</span><span class="token operator">:</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> Rule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">plan</span><span class="token operator">:</span><span class="token plain"> LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> LogicalPlan </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/* Code for custom logical optimier */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> customOptimizerFunc</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">extensionBuilder</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  extensionBuilder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">injectOptimizerRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CustomOptimizer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="44-custom-physical-planning">4.4. Custom physical planning<a class="hash-link" href="#44-custom-physical-planning" title="Direct link to heading">​</a></h4><p>To configure the running strategy for Spark Catalyst optimizer, we inherit the abstract class <code>SparkStrategy</code> and implement the method <code>apply</code> of that class</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> CustomStrategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">sparkSession</span><span class="token operator">:</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> SparkStrategy </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">plan</span><span class="token operator">:</span><span class="token plain"> LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">SparkPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/* Code for custom spark strategy/physical planning */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> customStrategyFunc</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">extensionBuilder</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  extensionBuilder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">injectPlannerStrategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CustomStrategy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="45-example-code-to-configuree-logical-plan-optimization-phase-in-catalyst-optimizer">4.5. Example code to configuree logical plan optimization phase in Catalyst optimizer<a class="hash-link" href="#45-example-code-to-configuree-logical-plan-optimization-phase-in-catalyst-optimizer" title="Direct link to heading">​</a></h4><p>In this section, I will make an example of changing logical plan optimization phase with Spark extension. A simple extension with code as below</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">/* class CustomProjectFilterExtension ======================================= */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> </span><span class="token namespace">extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SparkSession</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">catalyst</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">plans</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">logical</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">catalyst</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">rules</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Rule</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// create an extension that</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> CustomProjectFilterExtension</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">spark</span><span class="token operator">:</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> Rule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">plan</span><span class="token operator">:</span><span class="token plain"> LogicalPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> LogicalPlan </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">val</span><span class="token plain"> fixedPlan </span><span class="token operator">=</span><span class="token plain"> plan transformDown </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> Project</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">expression</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          Filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> child</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fixedPlan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/* class AllExtensions ======================================= */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> </span><span class="token namespace">extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token namespace">org</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">apache</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">spark</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token namespace">sql</span><span class="token namespace punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SparkSessionExtensions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// inject the extension to SparkSessionExtensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> AllExtensions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">extends</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SparkSessionExtensions </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">override</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ext</span><span class="token operator">:</span><span class="token plain"> SparkSessionExtensions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Unit</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">injectOptimizerRule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CustomProjectFilterExtension</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above class <code>CustomProjectFilterExtension</code> transforms Filter (row filter), Project (select column while scanning file) operators to only Filter. Then, even though we have selected the column, it still scans all the columns of the file in the storage.</p><p>Compile project</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># compile jar file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mvn clean package </span><span class="token operator">&amp;&amp;</span><span class="token plain"> mvn dependency:copy-dependencies</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="451-when-not-applying-extension">4.5.1. When not applying extension<a class="hash-link" href="#451-when-not-applying-extension" title="Direct link to heading">​</a></h5><p>We initialize <code>spark-shell</code> without passing extension</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># initialize spark-shell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_330</span><span class="token plain">/bin/spark-shell --jars </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> /Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/target/dependency/*.jar </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">tr</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&#x27; &#x27;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&#x27;,&#x27;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain">,/Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/target/custom-extension-1.0-SNAPSHOT.jar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># check spark.sql.extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.conf.get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;spark.sql.extensions&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">res0: String </span><span class="token operator">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># explain a query that contains Filter and Project operators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;SELECT hotel, is_canceled FROM (SELECT * FROM test.hotel_bookings WHERE hotel=&#x27;Resort Hotel&#x27;) a&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">.explain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">extended </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Parsed Logical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Project [&#x27;</span><span class="token plain">hotel, </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;is_canceled]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">+- &#x27;</span><span class="token plain">SubqueryAlias a</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   +- </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Project [*]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      +- &#x27;</span><span class="token plain">Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;hotel = Resort Hotel)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">         +- &#x27;</span><span class="token plain">UnresolvedRelation </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">test, hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">, </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Analyzed Logical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hotel: string, is_canceled: bigint</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Project </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0, is_canceled#1L]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+- SubqueryAlias a</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   +- Project </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0, is_canceled#1L, lead_time#2L, arrival_date_year#3L, arrival_date_month#4, arrival_date_week_number#5L, arrival_date_day_of_month#6L, stays_in_weekend_nights#7L, stays_in_week_nights#8L, adults#9L, children#10, babies#11L, meal#12, country#13, market_segment#14, distribution_channel#15, is_repeated_guest#16L, previous_cancellations#17L, previous_bookings_not_canceled#18L, reserved_room_type#19, assigned_room_type#20, booking_changes#21L, deposit_type#22, agent#23, ... 8 more fields]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      +- Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0 = Resort Hotel)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         +- SubqueryAlias spark_catalog.test.hotel_bookings</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            +- Relation test.hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0,is_canceled#1L,lead_time#2L,arrival_date_year#3L,arrival_date_month#4,arrival_date_week_number#5L,arrival_date_day_of_month#6L,stays_in_weekend_nights#7L,stays_in_week_nights#8L,adults#9L,children#10,babies#11L,meal#12,country#13,market_segment#14,distribution_channel#15,is_repeated_guest#16L,previous_cancellations#17L,previous_bookings_not_canceled#18L,reserved_room_type#19,assigned_room_type#20,booking_changes#21L,deposit_type#22,agent#23,... 8 more fields] parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Optimized Logical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Project </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0, is_canceled#1L]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+- Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">isnotnull</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0) AND (hotel#0 = Resort Hotel))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   +- Relation test.hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0,is_canceled#1L,lead_time#2L,arrival_date_year#3L,arrival_date_month#4,arrival_date_week_number#5L,arrival_date_day_of_month#6L,stays_in_weekend_nights#7L,stays_in_week_nights#8L,adults#9L,children#10,babies#11L,meal#12,country#13,market_segment#14,distribution_channel#15,is_repeated_guest#16L,previous_cancellations#17L,previous_bookings_not_canceled#18L,reserved_room_type#19,assigned_room_type#20,booking_changes#21L,deposit_type#22,agent#23,... 8 more fields] parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Physical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">isnotnull</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0) AND (hotel#0 = Resort Hotel))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+- *</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> ColumnarToRow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   +- FileScan parquet test.hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0,is_canceled#1L] Batched: true, DataFilters: [isnotnull(hotel#0), (hotel#0 = Resort Hotel)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/sp..., PartitionFilters: [], PushedFilters: [IsNotNull(hotel), EqualTo(hotel,Resort Hotel)], ReadSchema: struct&lt;hotel:string,is_canceled:bigint&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see that <code>Optimized Logical Plan</code> there are both Project and Filter operations, because we filter <code>WHERE hotel=&#x27;Resort Hotel&#x27;</code> and project <code>SELECT hotel, is_canceled</code>. Therefore, in the physical plan, it only scans 2 columns <code>FileScan parquet test.hotel_bookings[hotel#0,is_canceled#1L]</code>.</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="452-when-applying-extension">4.5.2. When applying extension<a class="hash-link" href="#452-when-applying-extension" title="Direct link to heading">​</a></h5><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># initialize spark-shell with extension</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_330</span><span class="token plain">/bin/spark-shell --jars </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable builtin class-name" style="color:rgb(189, 147, 249);font-style:italic">echo</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> /Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/target/dependency/*.jar </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">tr</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&#x27; &#x27;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">&#x27;,&#x27;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain">,/Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/target/custom-extension-1.0-SNAPSHOT.jar --conf spark.sql.extensions</span><span class="token operator">=</span><span class="token plain">extensions.AllExtensions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># check spark.sql.extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.conf.get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;spark.sql.extensions&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">res0: String </span><span class="token operator">=</span><span class="token plain"> extensions.AllExtensions</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># explain a query that contains Filter and Project operators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;SELECT hotel, is_canceled FROM (SELECT * FROM test.hotel_bookings WHERE hotel=&#x27;Resort Hotel&#x27;) a&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">.explain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">extended </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Parsed Logical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Project [&#x27;</span><span class="token plain">hotel, </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;is_canceled]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">+- &#x27;</span><span class="token plain">SubqueryAlias a</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   +- </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Project [*]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">      +- &#x27;</span><span class="token plain">Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;hotel = Resort Hotel)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">         +- &#x27;</span><span class="token plain">UnresolvedRelation </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">test, hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">, </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Analyzed Logical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hotel: string, is_canceled: bigint</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Project </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0, is_canceled#1L]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+- SubqueryAlias a</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   +- Project </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0, is_canceled#1L, lead_time#2L, arrival_date_year#3L, arrival_date_month#4, arrival_date_week_number#5L, arrival_date_day_of_month#6L, stays_in_weekend_nights#7L, stays_in_week_nights#8L, adults#9L, children#10, babies#11L, meal#12, country#13, market_segment#14, distribution_channel#15, is_repeated_guest#16L, previous_cancellations#17L, previous_bookings_not_canceled#18L, reserved_room_type#19, assigned_room_type#20, booking_changes#21L, deposit_type#22, agent#23, ... 8 more fields]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      +- Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0 = Resort Hotel)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         +- SubqueryAlias spark_catalog.test.hotel_bookings</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            +- Relation test.hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0,is_canceled#1L,lead_time#2L,arrival_date_year#3L,arrival_date_month#4,arrival_date_week_number#5L,arrival_date_day_of_month#6L,stays_in_weekend_nights#7L,stays_in_week_nights#8L,adults#9L,children#10,babies#11L,meal#12,country#13,market_segment#14,distribution_channel#15,is_repeated_guest#16L,previous_cancellations#17L,previous_bookings_not_canceled#18L,reserved_room_type#19,assigned_room_type#20,booking_changes#21L,deposit_type#22,agent#23,... 8 more fields] parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Optimized Logical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">isnotnull</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0) AND (hotel#0 = Resort Hotel))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+- Relation test.hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0,is_canceled#1L,lead_time#2L,arrival_date_year#3L,arrival_date_month#4,arrival_date_week_number#5L,arrival_date_day_of_month#6L,stays_in_weekend_nights#7L,stays_in_week_nights#8L,adults#9L,children#10,babies#11L,meal#12,country#13,market_segment#14,distribution_channel#15,is_repeated_guest#16L,previous_cancellations#17L,previous_bookings_not_canceled#18L,reserved_room_type#19,assigned_room_type#20,booking_changes#21L,deposit_type#22,agent#23,... 8 more fields] parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">==</span><span class="token plain"> Physical Plan </span><span class="token operator">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">isnotnull</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0) AND (hotel#0 = Resort Hotel))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+- *</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> ColumnarToRow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   +- FileScan parquet test.hotel_bookings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">hotel</span><span class="token comment" style="color:rgb(98, 114, 164)">#0,is_canceled#1L,lead_time#2L,arrival_date_year#3L,arrival_date_month#4,arrival_date_week_number#5L,arrival_date_day_of_month#6L,stays_in_weekend_nights#7L,stays_in_week_nights#8L,adults#9L,children#10,babies#11L,meal#12,country#13,market_segment#14,distribution_channel#15,is_repeated_guest#16L,previous_cancellations#17L,previous_bookings_not_canceled#18L,reserved_room_type#19,assigned_room_type#20,booking_changes#21L,deposit_type#22,agent#23,... 8 more fields] Batched: true, DataFilters: [isnotnull(hotel#0), (hotel#0 = Resort Hotel)], Format: Parquet, Location: InMemoryFileIndex(1 paths)[file:/Users/tranlammacbook/Documents/spark_streaming_kafka/spark_ex/sp..., PartitionFilters: [], PushedFilters: [IsNotNull(hotel), EqualTo(hotel,Resort Hotel)], ReadSchema: struct&lt;hotel:string,is_canceled:bigint,lead_time:bigint,arrival_date_year:bigint,arrival_date_mon...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point, <code>Optimized Logical Plan</code> there is no longer Project operator, but only Filter operator, so that when it comes to the physical plan step, it scans all the columns in the table <code>FileScan parquet test.hotel_bookings[hotel#0,is_canceled#1L,lead_time#2L,arrival_date_year#3L,arrival_date_month#4,arrival_date_week_number#5L,arrival_date_day_of_month#6L,stays_in_weekend_nights#7L,stays_in_week_nights#8L,adults#9L,children#10,babies#11L,meal#12,country#13,market_segment#14,distribution_channel#15,is_repeated_guest#16L,previous_cancellations#17L,previous_bookings_not_canceled#18L,reserved_room_type#19,assigned_room_type#20,booking_changes#21L,deposit_type#22,agent#23,... 8 more fields]</code>.</p><p>Above, I have specifically presented the components of Spark Catalyst optimizer and how to write spark session extensions to intervene to change Catalyst&#x27;s plans, there are also specific code examples to demonstrate this. In the next article, I will present one more part that is a new feature in Spark 3.0, which is Spark Adaptive Query Execution, a feature that improves Spark job speed at runtime.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-references">5. References<a class="hash-link" href="#5-references" title="Direct link to heading">​</a></h3><p><a href="https://www.databricks.com/blog/2015/04/13/deep-dive-into-spark-sqls-catalyst-optimizer.html" target="_blank" rel="noopener noreferrer">Deep Dive into Spark SQL&#x27;s Catalyst Optimizer</a></p><p><a href="https://www.unraveldata.com/resources/catalyst-analyst-a-deep-dive-into-sparks-optimizer/" target="_blank" rel="noopener noreferrer">Spark Catalyst Pipeline: A Deep Dive Into Spark’s Optimizer</a></p><p><a href="https://medium.com/@pratikbarhate/extending-apache-spark-catalyst-for-custom-optimizations-9b491efdd24f" target="_blank" rel="noopener noreferrer">Extending Apache Spark Catalyst for Custom Optimizations</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_u0Nl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/bigdata">Bigdata</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/spark">Spark</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blogs/blog/tags/apache">Apache</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lam1051999/blogs/edit/main/blog/2023-01-07-spark-catalyst-optimizer-and-spark-extension/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div class="margin-vert--xl"></div><div class="margin-vert--lg" style="display:flex;align-items:center;justify-content:center"><a class="button button--link" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Flam1051999.github.io%2F%2Fblogs%2Fblog%2Fspark-catalyst-optimizer-and-spark-session-extension&amp;text=I%20just%20read%20%22Spark%20Catalyst%20Optimizer%20And%20Spark%20Session%20Extension%22%20by%20%40lamtt1005" target="_blank" rel="noreferrer noopener" style="display:inline-flex;align-items:center"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 248 204" height="20" width="20" style="margin-right:7px"><g><path fill="#1D9BF0" d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04 C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66 c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64 c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76 c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26 c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"></path></g></svg>Share on Twitter</a></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blogs/blog/state-management-react"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">State Management In React</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blogs/blog/mysql-series-mysql-indexing"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">MySQL series - Indexing</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-treenode" class="table-of-contents__link toc-highlight">1. TreeNode</a></li><li><a href="#2-rules" class="table-of-contents__link toc-highlight">2. Rules</a></li><li><a href="#3-catalyst-operations-in-spark-sql" class="table-of-contents__link toc-highlight">3. Catalyst Operations in Spark SQL</a><ul><li><a href="#31-parsing-and-analyzing" class="table-of-contents__link toc-highlight">3.1. Parsing and Analyzing</a></li><li><a href="#32-logical-plan-optimizations" class="table-of-contents__link toc-highlight">3.2. Logical plan optimizations</a></li><li><a href="#33-physical-planning" class="table-of-contents__link toc-highlight">3.3. Physical planning</a></li><li><a href="#34-code-generation" class="table-of-contents__link toc-highlight">3.4. Code generation</a></li></ul></li><li><a href="#4-spark-session-extension" class="table-of-contents__link toc-highlight">4. Spark session extension</a><ul><li><a href="#41-custom-parser-rule" class="table-of-contents__link toc-highlight">4.1. Custom parser rule</a></li><li><a href="#42-custom-analyzer-rule" class="table-of-contents__link toc-highlight">4.2. Custom analyzer rule</a></li><li><a href="#43-custom-optimization" class="table-of-contents__link toc-highlight">4.3. Custom optimization</a></li><li><a href="#44-custom-physical-planning" class="table-of-contents__link toc-highlight">4.4. Custom physical planning</a></li><li><a href="#45-example-code-to-configuree-logical-plan-optimization-phase-in-catalyst-optimizer" class="table-of-contents__link toc-highlight">4.5. Example code to configuree logical plan optimization phase in Catalyst optimizer</a><ul><li><a href="#451-when-not-applying-extension" class="table-of-contents__link toc-highlight">4.5.1. When not applying extension</a></li><li><a href="#452-when-applying-extension" class="table-of-contents__link toc-highlight">4.5.2. When applying extension</a></li></ul></li></ul></li><li><a href="#5-references" class="table-of-contents__link toc-highlight">5. References</a></li></ul></div></div></div></div></div><div class="footer-wrapper footer--dark"><div class="container margin-vert--lg"><div style="display:flex;justify-content:center"><div style="max-width:650px">I am a highly motivated and passionate data engineer. I often work with Python, Scala, and Java and use the latest big data technologies to solve problems, making tools to improve my and others&#x27; work productivity.</div><div style="margin-left:30px;min-width:169px"><img src="/blogs/img/avatar.jpg" style="height:154px;width:139px"><p style="font-size:0.8em;margin-top:1em">Lam Tran<br>Data Engineer</p></div></div></div><div style="display:flex;justify-content:center"><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blogs/">About</a></li><li class="footer__item"><a class="footer__link-item" href="/blogs/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:lam1051999@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/lamtt1005" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="tel:+84962007024" target="_blank" rel="noopener noreferrer" class="footer__link-item">Phone<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Lam Tran. All content is the property of Lam Tran.</div></div></div></footer></div></div></div>
<script src="/blogs/assets/js/runtime~main.98e4ac19.js"></script>
<script src="/blogs/assets/js/main.1d670f4e.js"></script>
</body>
</html>