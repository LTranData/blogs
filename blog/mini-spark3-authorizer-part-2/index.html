<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PK0DHL0FKW"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-PK0DHL0FKW",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Lam Tran" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Lam Tran RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Lam Tran Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous">
<script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7172314318777821" async crossorigin="anonymous"></script><title data-rh="true">Authorize Spark 3 SQL With Apache Ranger Part 2 - Integrate Spark SQL With Ranger</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lam-tran.dev//blog/mini-spark3-authorizer-part-2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="keywords" content="Data Engineering, Web Development, Blog"><meta data-rh="true" name="title" content="Lam Tran"><meta data-rh="true" property="og:title" content="Authorize Spark 3 SQL With Apache Ranger Part 2 - Integrate Spark SQL With Ranger | Lam Tran"><meta data-rh="true" name="description" content="Authorize Spark 3 SQL With Apache Ranger Part 2 - Integrate Spark SQL With Ranger"><meta data-rh="true" property="og:description" content="Authorize Spark 3 SQL With Apache Ranger Part 2 - Integrate Spark SQL With Ranger"><meta data-rh="true" property="og:image" content="https://lam-tran.dev//assets/images/banner-f7f67c4c18838de8d49230557182b09d.PNG"><meta data-rh="true" name="twitter:image" content="https://lam-tran.dev//assets/images/banner-f7f67c4c18838de8d49230557182b09d.PNG"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-05-01T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/lam1051999"><meta data-rh="true" property="article:tag" content="Bigdata,Spark,Ranger,Apache"><link data-rh="true" rel="icon" href="/img/lt_logo.svg"><link data-rh="true" rel="canonical" href="https://lam-tran.dev//blog/mini-spark3-authorizer-part-2"><link data-rh="true" rel="alternate" href="https://lam-tran.dev//blog/mini-spark3-authorizer-part-2" hreflang="en"><link data-rh="true" rel="alternate" href="https://lam-tran.dev//blog/mini-spark3-authorizer-part-2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GIW3CHZWR8-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.2e718d97.css">
<link rel="preload" href="/assets/js/runtime~main.2ccc56fd.js" as="script">
<link rel="preload" href="/assets/js/main.22b74e23.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/lt_logo.svg" alt="TL Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/lt_logo.svg" alt="TL Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Lam Tran</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-is-memory-managed-in-spark">How Is Memory Managed In Spark?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/state-management-react">State Management In React</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/mini-spark3-authorizer-part-2">Authorize Spark 3 SQL With Apache Ranger Part 2 - Integrate Spark SQL With Ranger</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mini-spark3-authorizer-part-1">Authorize Spark 3 SQL With Apache Ranger Part 1 - Ranger installation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/spark-catalyst-optimizer-and-spark-session-extension">Spark Catalyst Optimizer And Spark Session Extension</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-indexing">MySQL series - Indexing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-mvcc">MySQL series - Multiversion concurrency control</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-transaction">MySQL series - Transaction In MySQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mysql-series-mysql-architecture">MySQL series - MySQL Architecture Overview</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/spark-kafka-docker">Create A Data Streaming Pipeline With Spark Streaming, Kafka And Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/spark-cluster-docker">Create A Standalone Spark Cluster With Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/avl-tree">AVL Tree, AVL Sorting Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/binarysearch-tree">Binary Search Tree</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sorting-algorithms">Fundamental Sorting Algorithms</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/peak-finding">Peak Finding Algorithm</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">Authorize Spark 3 SQL With Apache Ranger Part 2 - Integrate Spark SQL With Ranger</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2023-05-01T00:00:00.000Z" itemprop="datePublished">May 1, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/lam1051999.png" alt="Lam Tran"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lam Tran</span></a></div><small class="avatar__subtitle" itemprop="description">Data Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://lam-tran.dev//assets/images/banner-f7f67c4c18838de8d49230557182b09d.PNG"><div id="post-content" class="markdown" itemprop="articleBody"><p>In the <strong><a href="/blog/mini-spark3-authorizer-part-1">previous blog</a></strong>, I have successfully installed a standalone Ranger service. In this article, I show you how we can customize the logical plan phase of <strong><a href="/blog/spark-catalyst-optimizer-and-spark-session-extension">Spark Catalyst Optimizer</a></strong> in order to archive authorization in Spark SQL with Ranger.</p><p><img loading="lazy" alt="banner" src="/assets/images/banner-f7f67c4c18838de8d49230557182b09d.PNG" width="751" height="286" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-spark-installation">1. Spark installation<a class="hash-link" href="#1-spark-installation" title="Direct link to heading">​</a></h3><p>Firstly, I will install Apache Spark 3.3.0 on my local machine. It is pretty easy with a few below steps.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get Spark build with hadoop, you can find specific version here: https://archive.apache.org/dist/spark/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> ~</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://archive.apache.org/dist/spark/spark-3.3.0/spark-3.3.0-bin-hadoop3.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -xvf spark-3.3.0-bin-hadoop3.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> spark-3.3.0-bin-hadoop3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Configure some environment variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SPARK_HOME</span><span class="token operator">=~</span><span class="token plain">/spark-3.3.0-bin-hadoop3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">export</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:rgb(189, 147, 249);font-style:italic">PATH</span><span class="token operator">=</span><span class="token environment constant" style="color:rgb(189, 147, 249)">$PATH</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_HOME</span><span class="token plain">/bin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check if Spark is installed properly</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark-shell</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-build-a-mini-spark-session-extension-for-ranger-authorization">2. Build a mini Spark Session Extension for Ranger authorization<a class="hash-link" href="#2-build-a-mini-spark-session-extension-for-ranger-authorization" title="Direct link to heading">​</a></h3><p>The idea to make the authorizer is first inspired by <a href="https://github.com/yaooqinn/spark-ranger" target="_blank" rel="noopener noreferrer">this GitHub repository</a>. Currently, this repository has been archived and it is only compatible with Spark 2.4 and below, which does not help our use case (we use Spark 3.3.0). After weeks of trying multiple solutions but not having a result, I end up customizing the repository to work with Spark 3.3.0 myself.</p><p>Spark makes a huge update to migrate from 2.4 to 3.0 (see detail <a href="https://spark.apache.org/docs/latest/sql-migration-guide.html#upgrading-from-spark-sql-24-to-30" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://spark.apache.org/releases/spark-release-3-0-0.html" target="_blank" rel="noopener noreferrer">here</a>) which create many new features. So we need to add more code and configure the project dependencies correctly in order not to conflict with Spark 3 dependencies (since Ranger and Spark 3 use the same library <code>jersey</code> to build RESTful Web Services, Ranger uses 1.x and Spark 3 uses 2.x).</p><p>The idea is to create a Spark Session Extension to customize the logical plan optimization phase of Spark Catalyst Optimizer, and since the logical plan is represented as <strong><a href="/blog/spark-catalyst-optimizer-and-spark-session-extension#1-treenode">TreeNode</a></strong>, it can be logical commands such as <code>CreateTableCommand</code>, <code>DropTableCommand</code>, <code>InsertIntoHiveTable</code>,... In these commands, we can extract the name of the database, table, and columns,... out of them, we collect them and check if the current user has proper access to those resources by Ranger-provided APIs.</p><p>The extension code can be found at: <strong><a href="https://github.com/lam1051999/mini_spark3_authorizer" target="_blank" rel="noopener noreferrer">https://github.com/lam1051999/mini_spark3_authorizer</a></strong>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Build the project</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> ~</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> clone https://github.com/lam1051999/mini_spark3_authorizer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> mini_spark3_authorizer/spark3-ranger-custom</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mvn clean package</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Copy output jar to Spark jars folder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cp</span><span class="token plain"> target/spark-ranger-1.0-SNAPSHOT.jar </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_HOME</span><span class="token plain">/jars</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Download dependency jars</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_HOME</span><span class="token plain">/jars</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://repo1.maven.org/maven2/commons-configuration/commons-configuration/1.10/commons-configuration-1.10.jar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://repo1.maven.org/maven2/com/kstruct/gethostname4j/1.0.0/gethostname4j-1.0.0.jar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://repo1.maven.org/maven2/net/java/dev/jna/jna/5.12.1/jna-5.12.1.jar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://repo1.maven.org/maven2/org/apache/kudu/kudu-spark3_2.12/1.16.0/kudu-spark3_2.12-1.16.0.jar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://repo1.maven.org/maven2/org/codehaus/jackson/jackson-jaxrs/1.9.13/jackson-jaxrs-1.9.13.jar</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://repo1.maven.org/maven2/org/codehaus/jackson/jackson-xc/1.9.13/jackson-xc-1.9.13.jar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After we have all the additional jars in Spark, we start to configure some properties for the extension.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Get the template configuration file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_HOME</span><span class="token plain">/conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cp</span><span class="token plain"> ~/mini_spark3_authorizer/spark3-conf/conf/ranger-spark-security.xml </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cp</span><span class="token plain"> ~/mini_spark3_authorizer/spark3-conf/conf/ranger-spark-audit.xml </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Modify the downloaded policy directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">vi</span><span class="token plain"> ranger-spark-security.xml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ranger.plugin.spark.policy.cache.dir</span><span class="token operator">=</span><span class="token operator">&lt;</span><span class="token plain">your_spark_home</span><span class="token operator">&gt;</span><span class="token plain">/security/policycache</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">mkdir</span><span class="token plain"> -p </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_HOME</span><span class="token plain">/security/policycache</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Copy template policy file. The filename need to be exactly below, because in the extension code, plugin appId = ranger_customized, in Ranger Admin UI, the service we are going to create will have the name = spark_sql</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">cp</span><span class="token plain"> ~/mini_spark3_authorizer/spark3-conf/security/policycache/ranger_customized_spark_sql.json </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_HOME</span><span class="token plain">/security/policycache</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At the moment, we go to Ranger Admin UI <code>http://localhost:6080</code> with <code>user/password = admin/YourPassword@123456</code>. In the <code>HIVE</code> plugin folder, create a service with the below input.</p><p><img loading="lazy" alt="service config" src="/assets/images/service_config-da6e13cecf4aa8cbb473060f8ead94ac.PNG" width="1332" height="711" class="img_ev3q"></p><p>We can test if the service policy is accessible through RESTful APIs or not and if it is downloadable.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -ivk -H </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Content-type:application/json&quot;</span><span class="token plain"> -u admin:YourPassword@123456 -X GET </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://localhost:6080/service/plugins/policies/download/spark_sql&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Add user you are going to test under <code>Settings -&gt; Users/Groups/Roles -&gt; Add New User</code>.</p><p><img loading="lazy" alt="user config" src="/assets/images/user_config-445294a579b9ef8455f30a0632dfa49c.PNG" width="1520" height="812" class="img_ev3q"></p><p>Add policy to the service <code>spark_sql</code>.</p><p><img loading="lazy" alt="policy config" src="/assets/images/policy_config-08227c613b3427511bf003c7d59f375e.PNG" width="1330" height="722" class="img_ev3q"></p><p>We create the database and table that we need.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Create a table to Spark metastore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark-shell</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> val </span><span class="token function" style="color:rgb(80, 250, 123)">df</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> spark.read.parquet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;file:///Users/tranlammacbook/mini_spark3_authorizer/jobs.parquet&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> df.printSchema</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">root</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">-- job_id: string </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nullable </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">-- company_id: string </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nullable </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">-- job_name: string </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nullable </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">-- taglist: string </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nullable </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">-- location: string </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nullable </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">-- three_reasons: string </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nullable </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">-- description: string </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nullable </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;CREATE DATABASE test;&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> df.write.mode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;overwrite&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">.format</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;parquet&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">.saveAsTable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;test.jobs&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can test our extension. As in the policy configuration, user <code>lamtran</code> only has permission to the columns <code>job_id, company_id, job_name</code> of table <code>test.jobs</code>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark-shell --conf spark.sql.extensions</span><span class="token operator">=</span><span class="token plain">mini.spark3.authorizer.RangerSparkSQLExtension --conf spark.sql.proxy-user</span><span class="token operator">=</span><span class="token plain">lamtran</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check Spark configurations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.conf.get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;spark.sql.extensions&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">res0: String </span><span class="token operator">=</span><span class="token plain"> mini.spark3.authorizer.RangerSparkSQLExtension</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.conf.get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;spark.sql.proxy-user&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">res1: String </span><span class="token operator">=</span><span class="token plain"> lamtran</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check permitted columns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;SELECT job_id, company_id, job_name FROM test.jobs LIMIT 10&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">.show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">truncate</span><span class="token operator">=</span><span class="token plain">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------------------------------------+--------------+----------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">job_id                                              </span><span class="token operator">|</span><span class="token plain">company_id    </span><span class="token operator">|</span><span class="token plain">job_name                                </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------------------------------------+--------------+----------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:jrsr_qa_engineer_kms_labs_bonus      </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Jr/Sr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> QA Engineer, KMS Labs - BONUS   </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:engineering_manager_bonus            </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Engineering Manager - BONUS             </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:fullstack_mobile_mobilenodejs_kobiton</span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Fullstack Mobile </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Mobile,NodeJs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Kobiton</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:jrsrprincipal_java_developer_bonus   </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Jr/Sr/Principal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Java Developer- BONUS </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:product_manager_kms_labs_bonus       </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Product Manager, KMS Labs - BONUS       </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:sr_it_business_analyst_english_bonus </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Sr IT Business Analyst </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">English</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> - BONUS</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:fullstack_dev_reactjsnodejs_kobiton  </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Fullstack Dev </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ReactJs,NodeJs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> - Kobiton</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:senior_ruby_on_rails_engineer_bonus  </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Senior Ruby on Rails Engineer - BONUS   </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:senior_data_engineer_bonus           </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Senior Data Engineer - BONUS            </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">kms-technology:srjr_fullstack_nodejsreactjs_bonus   </span><span class="token operator">|</span><span class="token plain">kms-technology</span><span class="token operator">|</span><span class="token plain">Sr/Jr Fullstack </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">NodeJS,ReactJS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> - BONUS</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------------------------------------+--------------+----------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Check columns that are not allowed to select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala</span><span class="token operator">&gt;</span><span class="token plain"> spark.sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;SELECT location, taglist, description FROM test.jobs LIMIT 10&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">.show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">truncate</span><span class="token operator">=</span><span class="token plain">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">23</span><span class="token plain">/07/01 </span><span class="token number">21</span><span class="token plain">:35:19 ERROR RangerSparkAuthorizerExtension: </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token plain">+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">Spark SQL Authorization Failure</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">-------------------------------</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">Permission denied: user </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">lamtran</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> does not have </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">SELECT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> privilege on </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">test/jobs/location,taglist,description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">-------------------------------</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">Spark SQL Authorization Failure</span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token plain">+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">org.apache.ranger.authorization.spark.authorizer.SparkAccessControlException: Permission denied: user </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">lamtran</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> does not have </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">SELECT</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> privilege on </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">test/jobs/location,taglist,description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.ranger.authorization.spark.authorizer.RangerSparkAuthorizer$.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$checkPrivileges</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RangerSparkAuthorizer.scala:127</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.ranger.authorization.spark.authorizer.RangerSparkAuthorizer$.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$checkPrivileges</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$6</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$adapted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RangerSparkAuthorizer.scala:124</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.Iterator.foreach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Iterator.scala:943</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.Iterator.foreach</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">Iterator.scala:943</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.AbstractIterator.foreach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Iterator.scala:1431</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.IterableLike.foreach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">IterableLike.scala:74</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.IterableLike.foreach</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">IterableLike.scala:73</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.AbstractIterable.foreach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Iterable.scala:56</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.ranger.authorization.spark.authorizer.RangerSparkAuthorizer$.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$checkPrivileges</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RangerSparkAuthorizer.scala:124</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.ranger.authorization.spark.authorizer.RangerSparkAuthorizer$.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$checkPrivileges</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$3</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$adapted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RangerSparkAuthorizer.scala:107</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.mutable.ResizableArray.foreach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ResizableArray.scala:62</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.mutable.ResizableArray.foreach</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">ResizableArray.scala:55</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.mutable.ArrayBuffer.foreach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ArrayBuffer.scala:49</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.ranger.authorization.spark.authorizer.RangerSparkAuthorizer$.checkPrivileges</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RangerSparkAuthorizer.scala:107</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.extensions.RangerSparkAuthorizerExtension.apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RangerSparkAuthorizerExtension.scala:58</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.extensions.RangerSparkAuthorizerExtension.apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RangerSparkAuthorizerExtension.scala:14</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.rules.RuleExecutor.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$execute</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RuleExecutor.scala:211</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.LinearSeqOptimized.foldLeft</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">LinearSeqOptimized.scala:126</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.LinearSeqOptimized.foldLeft</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$(</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">LinearSeqOptimized.scala:122</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.immutable.List.foldLeft</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">List.scala:91</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.rules.RuleExecutor.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$execute</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RuleExecutor.scala:208</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.rules.RuleExecutor.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$execute</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$1</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$adapted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RuleExecutor.scala:200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at scala.collection.immutable.List.foreach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">List.scala:431</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.rules.RuleExecutor.execute</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RuleExecutor.scala:200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.rules.RuleExecutor.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$executeAndTrack</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RuleExecutor.scala:179</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.QueryPlanningTracker$.withTracker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryPlanningTracker.scala:88</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.rules.RuleExecutor.executeAndTrack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RuleExecutor.scala:179</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$optimizedPlan</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:126</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.catalyst.QueryPlanningTracker.measurePhase</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryPlanningTracker.scala:111</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$executePhase</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:185</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution$.withInternalError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:510</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$executePhase</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:185</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.SparkSession.withActive</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SparkSession.scala:779</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.executePhase</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:184</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.optimizedPlan</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$lzycompute</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:122</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.optimizedPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:118</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.assertOptimized</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:136</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.executedPlan</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$lzycompute</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:154</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.executedPlan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:151</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.simpleString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:204</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.org</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$apache</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$spark</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$sql</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$execution</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$QueryExecution</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain">explainString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:249</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.QueryExecution.explainString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">QueryExecution.scala:218</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.SQLExecution$.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$withNewExecutionId</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SQLExecution.scala:103</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.SQLExecution$.withSQLConfPropagated</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SQLExecution.scala:169</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.SQLExecution$.</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$anonfun</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$withNewExecutionId</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SQLExecution.scala:95</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.SparkSession.withActive</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SparkSession.scala:779</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.execution.SQLExecution$.withNewExecutionId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SQLExecution.scala:64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.Dataset.withAction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Dataset.scala:3856</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.Dataset.head</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Dataset.scala:2863</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.Dataset.take</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Dataset.scala:3084</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.Dataset.getRows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Dataset.scala:288</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.Dataset.showString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Dataset.scala:327</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.Dataset.show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Dataset.scala:810</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  at org.apache.spark.sql.Dataset.show</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Dataset.scala:787</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">. </span><span class="token number">47</span><span class="token plain"> elided</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now check the downloaded policy file.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$SPARK_HOME</span><span class="token plain">/security/policycache</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">ls</span><span class="token plain"> -lh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-rw-r--r--  </span><span class="token number">1</span><span class="token plain"> tranlammacbook  staff    23K Jul  </span><span class="token number">1</span><span class="token plain"> </span><span class="token number">21</span><span class="token plain">:32 ranger_customized_spark_sql.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will see this is the new policy file and its content is refreshed every 10 seconds when the extension is in use.</p><p>Now, we can check the Ranger audit logs at <code>http://localhost:6080/index.html#!/reports/audit/bigData</code>.</p><p><img loading="lazy" alt="ranger audit" src="/assets/images/ranger_audit-d860c70e75b2c34bfa9d8908cc4e5676.PNG" width="2010" height="1104" class="img_ev3q"></p><p>To check if it is pushed in Solr or not, go to <code>http://localhost:6083/solr/#/ranger_audits/query</code> and click <strong>Execute Query</strong>.</p><p><img loading="lazy" alt="solr audit" src="/assets/images/solr_audit-6b76b5e2a88887f2d199a842d4572cfb.PNG" width="1994" height="1076" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-room-for-improvement">3. Room for improvement<a class="hash-link" href="#3-room-for-improvement" title="Direct link to heading">​</a></h3><p>In this blog, we integrate a local Spark 3 with a standalone Ranger, but in production, Spark is often used in corporate with a Hadoop data cluster with Kerberos authentication enabled. Ranger will also sit in that Hadoop and do the authorization for many frameworks in Hadoop. Thus, there are a few more things that we need to implement.</p><ul><li>Config Spark and Ranger to work with Hadoop, and run Spark job in cluster mode.</li><li>Policy refresher needs to be secure and use SPNego protocol (which use Kerberos keytab to generate token) to make RESTful API calls to Ranger service.</li><li>The user of the Spark application and the user for authorizing Ranger need to be the keytab principal user.</li></ul><p>I have also successfully implemented all the above functionalities in the production environment. If you need them, contact me on <strong><a href="https://www.linkedin.com/in/lamtt1005" target="_blank" rel="noopener noreferrer">Linkedin</a></strong>.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_u0Nl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/bigdata">Bigdata</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/spark">Spark</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ranger">Ranger</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/apache">Apache</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lam1051999/blogs/edit/main/blog/2023-05-01-mini-spark3-authorizer-part-2/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div class="margin-vert--xl"></div><div class="margin-vert--lg" style="display:flex;align-items:center;justify-content:center"><a class="button button--link" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Flam-tran.dev%2F%2Fblog%2Fmini-spark3-authorizer-part-2&amp;text=I%20just%20read%20%22Authorize%20Spark%203%20SQL%20With%20Apache%20Ranger%20Part%202%20-%20Integrate%20Spark%20SQL%20With%20Ranger%22%20by%20%40lamtt1005" target="_blank" rel="noreferrer noopener" style="display:inline-flex;align-items:center"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 248 204" height="20" width="20" style="margin-right:7px"><g><path fill="#1D9BF0" d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04 C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66 c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64 c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76 c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26 c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"></path></g></svg>Share on Twitter</a></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/state-management-react"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">State Management In React</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/mini-spark3-authorizer-part-1"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Authorize Spark 3 SQL With Apache Ranger Part 1 - Ranger installation</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-spark-installation" class="table-of-contents__link toc-highlight">1. Spark installation</a></li><li><a href="#2-build-a-mini-spark-session-extension-for-ranger-authorization" class="table-of-contents__link toc-highlight">2. Build a mini Spark Session Extension for Ranger authorization</a></li><li><a href="#3-room-for-improvement" class="table-of-contents__link toc-highlight">3. Room for improvement</a></li></ul></div></div></div></div></div><div class="footer-wrapper footer--dark"><div class="container margin-vert--lg"><div style="display:flex;justify-content:center"><div style="max-width:650px">I am a highly motivated and passionate data engineer. I often work with Python, Scala, and Java and use the latest big data technologies to solve problems, making tools to improve my and others&#x27; work productivity.<a target="_blank" rel="noreferrer noopener" href="https://www.buymeacoffee.com/lamtran" style="display:block;margin-top:10px"><img loading="lazy" style="height:50px;width:50px" src="/img/donate.jpg"></a></div><div style="margin-left:30px;min-width:162px"><img loading="lazy" src="/img/avatar.jpg" style="height:130px;width:136px"><p style="font-size:0.8em;margin-top:1em">Lam Tran<br>Data Engineer</p></div></div></div><div style="display:flex;justify-content:center"><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">About</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:lam1051999@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/lamtt1005" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="tel:+84962007024" target="_blank" rel="noopener noreferrer" class="footer__link-item">Phone<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/lam1051999" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Lam Tran. Powered by <a target="_blank" rel="noreferrer noopener" style="color:white;font-weight:bold;" href="https://docusaurus.io/">Docusaurus 2</a></div></div></div></footer></div></div></div>
<script src="/assets/js/runtime~main.2ccc56fd.js"></script>
<script src="/assets/js/main.22b74e23.js"></script>
</body>
</html>